<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UltraPlay OS v2.0</title>
    <meta name="theme-color" content="#0f0f0f">
    <style>
        /* --- CORE DESIGN SYSTEM --- */
        :root {
            --bg-color: #050505;
            --surface-color: rgba(30, 30, 30, 0.7);
            --surface-hover: rgba(255, 255, 255, 0.1);
            --accent-color: #00e5ff; /* Cyan Accent */
            --accent-glow: 0 0 15px rgba(0, 229, 255, 0.4);
            --text-primary: #ffffff;
            --text-secondary: #aaaaaa;
            --glass-border: 1px solid rgba(255, 255, 255, 0.08);
            --radius-md: 12px;
            --radius-lg: 18px;
            --font-main: 'Inter', system-ui, -apple-system, sans-serif;
        }

        /* --- RESET & BASE --- */
        * { box-sizing: border-box; outline: none; user-select: none; }
        body { 
            margin: 0; font-family: var(--font-main); background: var(--bg-color); 
            color: var(--text-primary); height: 100vh; overflow: hidden; 
            display: flex; flex-direction: column;
        }

        /* SCROLLBARS */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--accent-color); }

        /* --- LAYOUT GRID --- */
        #app {
            display: grid;
            grid-template-columns: 240px 1fr 280px;
            grid-template-rows: 1fr 80px;
            height: 100%; width: 100%;
        }

        /* --- SIDEBAR --- */
        .sidebar {
            background: rgba(10, 10, 10, 0.95);
            border-right: var(--glass-border);
            padding: 20px;
            display: flex; flex-direction: column; gap: 10px;
            backdrop-filter: blur(10px);
        }
        .app-logo {
            font-size: 1.2rem; font-weight: 800; letter-spacing: 1px;
            margin-bottom: 20px; color: var(--accent-color);
            text-shadow: var(--accent-glow); display: flex; align-items: center; gap: 10px;
        }
        .nav-btn {
            padding: 12px 16px; border-radius: var(--radius-md);
            cursor: pointer; color: var(--text-secondary);
            transition: all 0.2s; display: flex; align-items: center; gap: 12px;
            font-size: 0.9rem; font-weight: 500;
        }
        .nav-btn:hover { background: var(--surface-hover); color: white; }
        .nav-btn.active { background: rgba(0, 229, 255, 0.1); color: var(--accent-color); border-left: 3px solid var(--accent-color); }
        .nav-icon { width: 20px; height: 20px; fill: currentColor; }

        .playlist-header {
            margin-top: 20px; font-size: 0.75rem; color: #666; font-weight: 700; letter-spacing: 1px;
            display: flex; justify-content: space-between; align-items: center;
        }
        .add-pl-btn { cursor: pointer; font-size: 1.2rem; }
        .playlist-list { overflow-y: auto; flex: 1; margin-top: 10px; }

        /* --- MAIN STAGE --- */
        .stage {
            grid-column: 2; grid-row: 1; position: relative;
            background: #000; overflow: hidden; display: flex; align-items: center; justify-content: center;
        }
        
        /* Video & Canvas */
        #video-element { width: 100%; height: 100%; object-fit: contain; z-index: 1; }
        #visualizer-canvas { 
            position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); 
            z-index: 2; width: 60%; height: 100px; pointer-events: none; opacity: 0.8;
            display: none; /* Only for audio */
        }
        /* Library Overlay */
        .view-overlay {
            position: absolute; inset: 0; background: var(--bg-color); z-index: 10;
            padding: 25px; overflow-y: auto; display: none;
            animation: fadeIn 0.3s ease;
        }
        .view-overlay.active { display: block; }

        /* Grid for Media */
        .media-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 20px; padding-bottom: 50px;
        }
        .media-card {
            background: var(--surface-color); border-radius: var(--radius-md);
            overflow: hidden; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s;
            position: relative; border: var(--glass-border);
        }
        .media-card:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.5); border-color: var(--accent-color); }
        .thumb-box {
            height: 100px; background: #1a1a1a; position: relative;
            background-size: cover; background-position: center;
            display: flex; align-items: center; justify-content: center;
        }
        .duration-badge {
            position: absolute; bottom: 5px; right: 5px; background: rgba(0,0,0,0.8);
            color: white; font-size: 0.7rem; padding: 2px 6px; border-radius: 4px;
        }
        .info-box { padding: 10px; }
        .file-name { font-size: 0.85rem; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .file-meta { font-size: 0.7rem; color: #777; margin-top: 4px; display: flex; justify-content: space-between; }
        
        /* --- RIGHT PANEL (Queue & Settings) --- */
        .right-panel {
            grid-column: 3; grid-row: 1;
            background: rgba(15, 15, 15, 0.95);
            border-left: var(--glass-border);
            display: flex; flex-direction: column;
            backdrop-filter: blur(10px);
        }
        .panel-tabs {
            display: flex; border-bottom: var(--glass-border);
        }
        .panel-tab {
            flex: 1; padding: 15px; text-align: center; cursor: pointer;
            font-size: 0.85rem; color: var(--text-secondary);
            border-bottom: 2px solid transparent;
        }
        .panel-tab.active { color: var(--accent-color); border-bottom-color: var(--accent-color); }
        
        .panel-content { flex: 1; overflow-y: auto; position: relative; }
        .queue-item {
            padding: 10px 15px; display: flex; gap: 10px; cursor: pointer;
            border-bottom: 1px solid rgba(255,255,255,0.03); transition: background 0.2s;
        }
        .queue-item:hover { background: var(--surface-hover); }
        .queue-item.playing { background: rgba(0, 229, 255, 0.05); border-left: 2px solid var(--accent-color); }
        
        /* EQ & Filters UI inside Right Panel */
        .controls-group { padding: 20px; }
        .control-label { font-size: 0.75rem; color: #888; margin-bottom: 8px; display: flex; justify-content: space-between; }
        input[type="range"] {
            width: 100%; -webkit-appearance: none; height: 4px; background: #333;
            border-radius: 2px; margin-bottom: 15px;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none; width: 12px; height: 12px;
            background: var(--accent-color); border-radius: 50%; cursor: pointer;
            box-shadow: 0 0 10px var(--accent-color);
        }

        /* --- PLAYER CONTROLS (Bottom) --- */
        .player-bar {
            grid-column: 1 / -1; grid-row: 2;
            background: rgba(10, 10, 10, 0.95);
            border-top: var(--glass-border);
            display: flex; flex-direction: column;
            padding: 0 20px; z-index: 100;
        }
        .seek-container {
            width: 100%; height: 16px; display: flex; align-items: center; cursor: pointer;
            position: relative;
        }
        .seek-bg { width: 100%; height: 3px; background: #333; border-radius: 2px; overflow: hidden; }
        .seek-fill { height: 100%; background: var(--accent-color); width: 0%; }
        .seek-container:hover .seek-bg { height: 5px; }

        .controls-row {
            display: flex; align-items: center; justify-content: space-between; height: 60px;
        }
        .btn-circle {
            width: 40px; height: 40px; border-radius: 50%; border: none;
            background: transparent; color: #fff; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            transition: background 0.2s;
        }
        .btn-circle:hover { background: rgba(255,255,255,0.1); }
        .btn-circle.primary {
            background: var(--accent-color); color: #000; width: 48px; height: 48px;
            box-shadow: 0 0 15px rgba(0, 229, 255, 0.3);
        }
        .btn-circle.primary:hover { transform: scale(1.05); }
        
        .time-text { font-family: monospace; font-size: 0.8rem; color: #888; width: 100px; text-align: center; }

        /* --- UTILS --- */
        .hidden { display: none !important; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        /* Mobile Resp */
        @media(max-width: 900px) {
            #app { grid-template-columns: 1fr; grid-template-rows: 1fr 80px; }
            .sidebar, .right-panel { display: none; position: fixed; z-index: 200; height: 100%; top: 0; width: 80%; max-width: 300px; background: #111; box-shadow: 0 0 50px #000; }
            .sidebar.open, .right-panel.open { display: flex; }
            .mobile-menu-btn { display: block; }
        }
    </style>
</head>
<body>

<div id="app">
    <!-- SIDEBAR -->
    <aside class="sidebar" id="sidebar">
        <div class="app-logo">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="var(--accent-color)"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 14.5v-9l6 4.5-6 4.5z"/></svg>
            UltraPlay OS
        </div>
        
        <div class="nav-btn active" onclick="ui.switchView('library')">
            <svg class="nav-icon" viewBox="0 0 24 24"><path d="M20 6h-8l-2-2H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2zm0 12H4V8h16v10z"/></svg>
            Media Library
        </div>
        <div class="nav-btn" onclick="ui.switchView('player')">
            <svg class="nav-icon" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 14H9V8h2v8zm4 0h-2V8h2v8z"/></svg>
            Now Playing
        </div>
        <div class="nav-btn" onclick="document.getElementById('file-input').click()">
            <svg class="nav-icon" viewBox="0 0 24 24"><path d="M9 16h6v-6h4l-7-7-7 7h4zm-4 2h14v2H5z"/></svg>
            Import Files
        </div>
        
        <div class="playlist-header">
            <span>MY PLAYLISTS</span>
            <span class="add-pl-btn" onclick="playlistMgr.create()">+</span>
        </div>
        <div class="playlist-list" id="playlist-list">
            <!-- Dynamic Playlist Items -->
        </div>

        <button class="nav-btn" style="margin-top: auto; color: #ff5555;" onclick="db.wipe()">
            <svg class="nav-icon" viewBox="0 0 24 24"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>
            Reset App
        </button>
    </aside>

    <!-- STAGE -->
    <main class="stage">
        <!-- Video Layer -->
        <video id="video-element" playsinline crossorigin="anonymous"></video>
        <canvas id="visualizer-canvas"></canvas>

        <!-- Views -->
        <div id="library-view" class="view-overlay active">
            <h2 style="margin-top:0;">Library</h2>
            <div id="drop-zone" style="border: 2px dashed #333; padding: 20px; text-align: center; border-radius: 10px; margin-bottom: 20px; color: #666;">
                Drag & Drop media here
            </div>
            <div class="media-grid" id="media-grid"></div>
        </div>

        <!-- Toast -->
        <div id="toast" style="position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%); background: #222; padding: 10px 20px; border-radius: 20px; opacity: 0; transition: opacity 0.3s; pointer-events: none; border: 1px solid #444; z-index: 200;">Action Completed</div>
    </main>

    <!-- RIGHT PANEL -->
    <aside class="right-panel">
        <div class="panel-tabs">
            <div class="panel-tab active" onclick="ui.switchTab('queue')">Queue</div>
            <div class="panel-tab" onclick="ui.switchTab('audio')">Audio & Video</div>
        </div>

        <!-- Queue Tab -->
        <div id="tab-queue" class="panel-content">
            <div class="queue-list" id="queue-list"></div>
        </div>

        <!-- Audio/Video Tools Tab -->
        <div id="tab-audio" class="panel-content hidden">
            <div class="controls-group">
                <div class="control-label"><span>Volume</span> <span id="vol-val">100%</span></div>
                <input type="range" min="0" max="1" step="0.05" value="1" oninput="player.setVolume(this.value)">

                <div class="control-label"><span>Playback Speed</span> <span id="spd-val">1.0x</span></div>
                <input type="range" min="0.5" max="3" step="0.25" value="1" oninput="player.setSpeed(this.value)">
                
                <hr style="border: 0; border-top: 1px solid #333; margin: 15px 0;">
                
                <div class="control-label" style="color: var(--accent-color);">EQUALIZER (3-Band)</div>
                <div class="control-label">Bass</div>
                <input type="range" min="-10" max="10" value="0" oninput="audioEngine.setEq('bass', this.value)">
                <div class="control-label">Mid</div>
                <input type="range" min="-10" max="10" value="0" oninput="audioEngine.setEq('mid', this.value)">
                <div class="control-label">Treble</div>
                <input type="range" min="-10" max="10" value="0" oninput="audioEngine.setEq('treble', this.value)">

                <hr style="border: 0; border-top: 1px solid #333; margin: 15px 0;">
                
                <div class="control-label" style="color: var(--accent-color);">VIDEO FILTERS</div>
                <div class="control-label">Brightness</div>
                <input type="range" min="0.5" max="1.5" step="0.1" value="1" oninput="player.setFilter('brightness', this.value)">
                <div class="control-label">Contrast</div>
                <input type="range" min="0.5" max="1.5" step="0.1" value="1" oninput="player.setFilter('contrast', this.value)">
                <div class="control-label">Saturation</div>
                <input type="range" min="0" max="2" step="0.1" value="1" oninput="player.setFilter('saturate', this.value)">

                <button class="nav-btn" onclick="player.loadSubtitle()" style="width:100%; justify-content:center; background:#222; margin-top:10px;">Load Subtitle (.srt/.vtt)</button>
            </div>
        </div>
    </aside>

    <!-- PLAYER BAR -->
    <div class="player-bar">
        <div class="seek-container" id="seek-container">
            <div class="seek-bg"><div class="seek-fill" id="seek-fill"></div></div>
        </div>
        <div class="controls-row">
            <div style="display: flex; gap: 15px;">
                <button class="btn-circle" onclick="player.prev()"><svg width="24" height="24" fill="currentColor" viewBox="0 0 24 24"><path d="M6 6h2v12H6zm3.5 6l8.5 6V6z"/></svg></button>
                <button class="btn-circle primary" id="play-btn" onclick="player.togglePlay()"><svg width="32" height="32" fill="currentColor" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg></button>
                <button class="btn-circle" onclick="player.next()"><svg width="24" height="24" fill="currentColor" viewBox="0 0 24 24"><path d="M6 18l8.5-6L6 6v12zM16 6v12h2V6h-2z"/></svg></button>
            </div>
            
            <div class="time-text" id="time-display">00:00</div>

            <div style="display: flex; gap: 10px;">
                <button class="btn-circle" title="Picture in Picture" onclick="player.togglePip()"><svg width="20" height="20" fill="currentColor" viewBox="0 0 24 24"><path d="M19 11h-8v6h8v-6zm4 8V4.98C23 3.88 22.1 3 21 3H3c-1.1 0-2 .88-2 1.98V19c0 1.1.9 2 2 2h18c1.1 0 2-.9 2-2zm-2 .02H3V4.97h18v14.05z"/></svg></button>
                <button class="btn-circle" title="Fullscreen" onclick="player.toggleFullscreen()"><svg width="24" height="24" fill="currentColor" viewBox="0 0 24 24"><path d="M7 14H5v5h5v-2H7v-3zm-2-4h2V7h3V5H5v5zm12 7h-3v2h5v-5h-2v3zM14 5v2h3v3h2V5h-5z"/></svg></button>
            </div>
        </div>
    </div>
</div>

<input type="file" id="file-input" multiple accept="video/*,audio/*" class="hidden">
<input type="file" id="sub-input" accept=".srt,.vtt" class="hidden">

<script>
/**
 * ULTRA PLAY OS v2.0 - Optimized Core
 * 
 * Improvements: 
 * 1. Sequential Thumbnail Generation (Non-blocking)
 * 2. Web Audio API (Equalizer + Visualizer)
 * 3. Video Filters (CSS)
 */

const Utils = {
    fmtTime: s => {
        if (!s || isNaN(s)) return "00:00";
        return new Date(s * 1000).toISOString().substr(11, 8).replace(/^00:/, '');
    },
    uuid: () => Math.random().toString(36).substr(2, 9),
    srtToVtt: (srt) => {
        return "WEBVTT\n\n" + srt
            .replace(/(\d{2}):(\d{2}):(\d{2}),(\d{3})/g, '$1:$2:$3.$4')
            .replace(/(\r\n|\r|\n)/g, '\n');
    }
};

// --- DATABASE LAYER ---
class Store {
    constructor() {
        this.db = null;
        this.ready = this.init();
    }
    async init() {
        return new Promise((resolve) => {
            const req = indexedDB.open('UltraPlayV2', 2);
            req.onupgradeneeded = e => {
                const db = e.target.result;
                if (!db.objectStoreNames.contains('library')) db.createObjectStore('library', { keyPath: 'id' });
                if (!db.objectStoreNames.contains('playlists')) db.createObjectStore('playlists', { keyPath: 'id' });
            };
            req.onsuccess = e => { this.db = e.target.result; resolve(); };
        });
    }
    async add(file) {
        await this.ready;
        const meta = {
            id: Utils.uuid(), name: file.name, type: file.type, 
            blob: file, size: file.size, added: Date.now(), thumb: null
        };
        const tx = this.db.transaction('library', 'readwrite');
        tx.objectStore('library').add(meta);
        return new Promise(r => tx.oncomplete = () => r(meta));
    }
    async getAll() {
        await this.ready;
        return new Promise(r => {
            this.db.transaction('library').objectStore('library').getAll().onsuccess = e => r(e.target.result);
        });
    }
    async update(item) {
        const tx = this.db.transaction('library', 'readwrite');
        tx.objectStore('library').put(item);
    }
    async wipe() {
        indexedDB.deleteDatabase('UltraPlayV2');
        location.reload();
    }
}

// --- THUMBNAIL WORKER QUEUE ---
class ThumbWorker {
    constructor() {
        this.queue = [];
        this.processing = false;
    }
    enqueue(mediaItem) {
        if(mediaItem.type.startsWith('audio')) return; // No thumb for audio
        this.queue.push(mediaItem);
        this.process();
    }
    async process() {
        if (this.processing || this.queue.length === 0) return;
        this.processing = true;
        const item = this.queue.shift();

        try {
            const thumb = await this.generate(item.blob);
            item.thumb = thumb;
            await db.update(item); // Update DB with thumb
            ui.updateCardThumb(item.id, thumb);
        } catch(e) { console.error(e); }

        this.processing = false;
        setTimeout(() => this.process(), 100); // Breathe
    }
    generate(blob) {
        return new Promise(resolve => {
            const v = document.createElement('video');
            v.src = URL.createObjectURL(blob);
            v.muted = true;
            v.currentTime = 5;
            v.onseeked = () => {
                const c = document.createElement('canvas');
                c.width = 160; c.height = 90;
                c.getContext('2d').drawImage(v, 0, 0, 160, 90);
                resolve(c.toDataURL('image/jpeg', 0.6));
                URL.revokeObjectURL(v.src);
            };
            v.onerror = () => resolve(null);
            // Trigger load
            v.load(); 
        });
    }
}

// --- AUDIO ENGINE (EQ & VISUALIZER) ---
class AudioEngine {
    constructor(videoEl) {
        this.video = videoEl;
        this.ctx = new (window.AudioContext || window.webkitAudioContext)();
        this.src = this.ctx.createMediaElementSource(this.video);
        
        // EQ Nodes
        this.bass = this.ctx.createBiquadFilter();
        this.bass.type = 'lowshelf'; this.bass.frequency.value = 200;
        
        this.mid = this.ctx.createBiquadFilter();
        this.mid.type = 'peaking'; this.mid.frequency.value = 1000;
        
        this.treble = this.ctx.createBiquadFilter();
        this.treble.type = 'highshelf'; this.treble.frequency.value = 3000;

        // Analyser
        this.analyser = this.ctx.createAnalyser();
        this.analyser.fftSize = 64;

        // Chain
        this.src.connect(this.bass);
        this.bass.connect(this.mid);
        this.mid.connect(this.treble);
        this.treble.connect(this.analyser);
        this.analyser.connect(this.ctx.destination);

        this.setupVisualizer();
    }

    setEq(band, val) {
        if (band === 'bass') this.bass.gain.value = val;
        if (band === 'mid') this.mid.gain.value = val;
        if (band === 'treble') this.treble.gain.value = val;
    }

    setupVisualizer() {
        const canvas = document.getElementById('visualizer-canvas');
        const ctx = canvas.getContext('2d');
        const bufferLength = this.analyser.frequencyBinCount;
        const dataArray = new Uint8Array(bufferLength);

        const draw = () => {
            requestAnimationFrame(draw);
            // Only draw if audio is playing and not a video file (optional preference)
            if (this.video.paused) return;

            this.analyser.getByteFrequencyData(dataArray);
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            const barWidth = (canvas.width / bufferLength) * 2.5;
            let barHeight;
            let x = 0;

            for(let i = 0; i < bufferLength; i++) {
                barHeight = dataArray[i] / 2;
                ctx.fillStyle = `rgb(${barHeight + 100}, 229, 255)`;
                ctx.fillRect(x, canvas.height - barHeight, barWidth, barHeight);
                x += barWidth + 1;
            }
        };
        draw();
    }
}

// --- PLAYER LOGIC ---
class Player {
    constructor() {
        this.v = document.getElementById('video-element');
        this.queue = [];
        this.idx = -1;
        this.filters = { brightness: 1, contrast: 1, saturate: 1 };
        
        this.v.ontimeupdate = () => this.onTick();
        this.v.onended = () => this.next();
    }

    async load(media) {
        this.v.src = URL.createObjectURL(media.blob);
        this.v.play();
        ui.highlightQueue(this.idx);
        ui.switchView('player');
        
        // Audio mode handling
        const isAudio = media.type.startsWith('audio');
        document.getElementById('visualizer-canvas').style.display = isAudio ? 'block' : 'none';
        
        // Reset subtitles
        this.v.innerHTML = '';
    }

    playQueue(list, startIdx = 0) {
        this.queue = list;
        this.idx = startIdx;
        ui.renderQueue(list);
        this.load(this.queue[this.idx]);
    }

    togglePlay() {
        if (this.v.paused) this.v.play(); else this.v.pause();
        this.updateBtn();
    }

    updateBtn() {
        const btn = document.getElementById('play-btn');
        btn.innerHTML = this.v.paused 
            ? '<svg width="32" height="32" fill="currentColor" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>' 
            : '<svg width="32" height="32" fill="currentColor" viewBox="0 0 24 24"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>';
    }

    onTick() {
        const pct = (this.v.currentTime / this.v.duration) * 100 || 0;
        document.getElementById('seek-fill').style.width = pct + '%';
        document.getElementById('time-display').innerText = Utils.fmtTime(this.v.currentTime);
        this.updateBtn();
    }

    seek(pct) {
        if (this.v.duration) this.v.currentTime = this.v.duration * pct;
    }

    next() {
        if (this.idx < this.queue.length - 1) {
            this.idx++; this.load(this.queue[this.idx]);
        }
    }
    prev() {
        if (this.idx > 0) {
            this.idx--; this.load(this.queue[this.idx]);
        }
    }

    setVolume(v) { this.v.volume = v; document.getElementById('vol-val').innerText = Math.round(v*100)+'%'; }
    setSpeed(s) { this.v.playbackRate = s; document.getElementById('spd-val').innerText = s+'x'; }
    
    setFilter(name, val) {
        this.filters[name] = val;
        this.v.style.filter = `brightness(${this.filters.brightness}) contrast(${this.filters.contrast}) saturate(${this.filters.saturate})`;
    }

    toggleFullscreen() {
        if(!document.fullscreenElement) document.body.requestFullscreen();
        else document.exitFullscreen();
    }
    togglePip() {
        if(document.pictureInPictureElement) document.exitPictureInPicture();
        else this.v.requestPictureInPicture();
    }

    loadSubtitle() {
        const input = document.getElementById('sub-input');
        input.onchange = e => {
            const file = e.target.files[0];
            const reader = new FileReader();
            reader.onload = (evt) => {
                let content = evt.target.result;
                if(file.name.endsWith('.srt')) content = Utils.srtToVtt(content);
                
                const blob = new Blob([content], { type: 'text/vtt' });
                const url = URL.createObjectURL(blob);
                
                const track = document.createElement('track');
                track.kind = 'subtitles'; track.label = 'English'; track.srclang = 'en';
                track.src = url; track.default = true;
                this.v.appendChild(track);
                ui.toast('Subtitles Loaded');
            };
            reader.readAsText(file);
        };
        input.click();
    }
}

// --- UI MANAGER ---
class UI {
    constructor() {
        this.setupDragDrop();
        this.setupSeek();
    }

    switchView(view) {
        document.querySelectorAll('.view-overlay').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.nav-btn').forEach(el => el.classList.remove('active'));
        
        if (view === 'library') {
            document.getElementById('library-view').classList.add('active');
            document.querySelector('.nav-btn:nth-child(2)').classList.add('active');
        } else {
             document.querySelector('.nav-btn:nth-child(3)').classList.add('active');
        }
    }

    switchTab(tab) {
        document.querySelectorAll('.panel-content').forEach(el => el.classList.add('hidden'));
        document.querySelectorAll('.panel-tab').forEach(el => el.classList.remove('active'));
        document.getElementById(`tab-${tab}`).classList.remove('hidden');
        event.target.classList.add('active');
    }

    async renderLibrary() {
        const items = await db.getAll();
        const grid = document.getElementById('media-grid');
        grid.innerHTML = '';
        
        items.forEach(item => {
            const el = document.createElement('div');
            el.className = 'media-card';
            el.id = `card-${item.id}`;
            el.innerHTML = `
                <div class="thumb-box" style="background-image: url('${item.thumb || ''}')">
                    ${!item.thumb ? (item.type.startsWith('audio') ? 'ðŸŽµ' : 'ðŸŽ¬') : ''}
                </div>
                <div class="info-box">
                    <div class="file-name">${item.name}</div>
                    <div class="file-meta"><span>${(item.size/1024/1024).toFixed(1)}MB</span></div>
                </div>
            `;
            el.onclick = () => player.playQueue(items, items.indexOf(item));
            grid.appendChild(el);
            
            // Queue thumbnail generation if missing
            if (!item.thumb && item.type.startsWith('video')) thumbWorker.enqueue(item);
        });
    }

    updateCardThumb(id, url) {
        const card = document.getElementById(`card-${id}`);
        if(card) {
            const box = card.querySelector('.thumb-box');
            box.style.backgroundImage = `url('${url}')`;
            box.innerText = '';
        }
    }

    renderQueue(list) {
        const container = document.getElementById('queue-list');
        container.innerHTML = '';
        list.forEach((item, i) => {
            const div = document.createElement('div');
            div.className = `queue-item`;
            div.id = `q-${i}`;
            div.innerHTML = `<div style="overflow:hidden; text-overflow:ellipsis; white-space:nowrap; font-size:0.85rem;">${item.name}</div>`;
            div.onclick = () => { player.idx = i; player.load(item); };
            container.appendChild(div);
        });
    }

    highlightQueue(idx) {
        document.querySelectorAll('.queue-item').forEach(e => e.classList.remove('playing'));
        const el = document.getElementById(`q-${idx}`);
        if(el) {
            el.classList.add('playing');
            el.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
    }

    toast(msg) {
        const t = document.getElementById('toast');
        t.innerText = msg; t.style.opacity = 1;
        setTimeout(() => t.style.opacity = 0, 2000);
    }

    setupDragDrop() {
        const z = document.getElementById('drop-zone');
        z.ondragover = e => { e.preventDefault(); z.style.borderColor = 'var(--accent-color)'; };
        z.ondragleave = () => z.style.borderColor = '#333';
        z.ondrop = async e => {
            e.preventDefault(); z.style.borderColor = '#333';
            const files = Array.from(e.dataTransfer.files).filter(f => f.type.startsWith('video') || f.type.startsWith('audio'));
            if(!files.length) return;
            
            this.toast(`Importing ${files.length} files...`);
            for(const f of files) await db.add(f);
            this.renderLibrary();
        };

        document.getElementById('file-input').onchange = async e => {
            for(const f of e.target.files) await db.add(f);
            this.renderLibrary();
        };
    }

    setupSeek() {
        const el = document.getElementById('seek-container');
        el.onclick = e => {
            const rect = el.getBoundingClientRect();
            const pct = (e.clientX - rect.left) / rect.width;
            player.seek(pct);
        };
    }
}

// --- INIT SYSTEM ---
const db = new Store();
const thumbWorker = new ThumbWorker();
const ui = new UI();
const player = new Player();
let audioEngine; // Init on first user interaction to comply with browser autoplay policy

// Playlist placeholder logic (simplified)
const playlistMgr = {
    create: () => {
        const name = prompt("Playlist Name:");
        if(name) {
            const div = document.createElement('div');
            div.className = 'nav-btn';
            div.innerHTML = `<svg class="nav-icon" viewBox="0 0 24 24"><path d="M15 6H3v2h12V6zm0 4H3v2h12v-2zM3 16h8v-2H3v2zM17 6v8.18c-.31-.11-.65-.18-1-.18-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3V8h3V6h-5z"/></svg> ${name}`;
            document.getElementById('playlist-list').appendChild(div);
        }
    }
};

// Start
(async () => {
    await db.ready;
    await ui.renderLibrary();
    
    // Init Audio Context on first click
    document.body.addEventListener('click', () => {
        if(!audioEngine) audioEngine = new AudioEngine(document.getElementById('video-element'));
        if(audioEngine.ctx.state === 'suspended') audioEngine.ctx.resume();
    }, { once: true });
})();

</script>
</body>
</html>