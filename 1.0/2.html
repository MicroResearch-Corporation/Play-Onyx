<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UltraPlay OS v3.1 | Pro</title>
    <meta name="theme-color" content="#0a0a0a">
    <style>
        /* --- DESIGN TOKENS --- */
        :root {
            --bg-dark: #050505;
            --bg-panel: rgba(18, 18, 18, 0.75);
            --accent: #00f2ff;
            --accent-dim: rgba(0, 242, 255, 0.15);
            --text-main: #ffffff;
            --text-muted: #888888;
            --border: 1px solid rgba(255, 255, 255, 0.08);
            --radius: 16px;
            --font-stack: 'Segoe UI', 'Inter', system-ui, sans-serif;
            --trans: all 0.25s cubic-bezier(0.25, 0.8, 0.25, 1);
        }

        /* --- BASE --- */
        * { box-sizing: border-box; outline: none; user-select: none; -webkit-tap-highlight-color: transparent; }
        body {
            margin: 0; background: var(--bg-dark); color: var(--text-main);
            font-family: var(--font-stack); height: 100vh; overflow: hidden;
            background-image: radial-gradient(circle at 10% 20%, #1a1a2e 0%, #000 50%);
        }

        /* --- APP GRID --- */
        #app {
            display: grid;
            grid-template-columns: 260px 1fr 300px;
            grid-template-rows: 1fr 90px;
            height: 100%; width: 100%;
        }

        /* --- SIDEBAR --- */
        .sidebar {
            background: var(--bg-panel); border-right: var(--border);
            padding: 24px; display: flex; flex-direction: column; gap: 8px;
            backdrop-filter: blur(20px); z-index: 10;
        }
        .logo {
            font-size: 1.4rem; font-weight: 800; letter-spacing: -0.5px;
            margin-bottom: 30px; color: var(--text-main); display: flex; align-items: center; gap: 12px;
        }
        .logo svg { fill: var(--accent); filter: drop-shadow(0 0 8px var(--accent)); }
        
        .nav-item {
            padding: 12px 16px; border-radius: 10px; cursor: pointer;
            color: var(--text-muted); font-weight: 500; font-size: 0.95rem;
            display: flex; align-items: center; gap: 14px; transition: var(--trans);
        }
        .nav-item:hover { background: rgba(255,255,255,0.05); color: #fff; }
        .nav-item.active { background: var(--accent-dim); color: var(--accent); }
        .nav-item svg { width: 20px; height: 20px; fill: currentColor; }
        
        .sidebar-divider { height: 1px; background: rgba(255,255,255,0.1); margin: 15px 0; }
        .btn-reset { margin-top: auto; color: #ff4757; }

        /* --- MAIN STAGE --- */
        .stage {
            grid-column: 2; position: relative; background: #000;
            overflow: hidden; display: flex; align-items: center; justify-content: center;
        }
        video { width: 100%; height: 100%; object-fit: contain; }
        
        #visualizer {
            position: absolute; bottom: 0; left: 0; width: 100%; height: 30%;
            pointer-events: none; opacity: 0.6; mix-blend-mode: screen; z-index: 5;
        }

        /* --- SHORTCUTS FLOATING PANEL --- */
        .shortcuts-panel {
            position: absolute; top: 20px; right: 20px; z-index: 50;
            display: flex; flex-direction: column; align-items: flex-end;
            transition: opacity 0.3s;
        }
        .stage:hover .shortcuts-panel { opacity: 1; }
        /* Auto hide when not hovering stage to reduce clutter */
        
        .shortcuts-trigger {
            width: 36px; height: 36px; background: rgba(255,255,255,0.05);
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            cursor: pointer; font-weight: 700; border: 1px solid rgba(255,255,255,0.1);
            transition: 0.3s; color: rgba(255,255,255,0.7);
            backdrop-filter: blur(5px);
        }
        .shortcuts-trigger:hover { background: var(--accent); color: #000; border-color: var(--accent); box-shadow: 0 0 15px var(--accent); }
        
        .shortcuts-list {
            margin-top: 10px; background: rgba(10,10,10,0.85); backdrop-filter: blur(15px);
            padding: 15px; border-radius: 16px; border: 1px solid rgba(255,255,255,0.1);
            transform: scale(0.95); opacity: 0; pointer-events: none; transition: 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            transform-origin: top right; width: 240px; box-shadow: 0 10px 40px rgba(0,0,0,0.5);
        }
        .shortcuts-panel:hover .shortcuts-list { opacity: 1; transform: scale(1); pointer-events: auto; }
        
        .k-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; font-size: 0.8rem; color: #ccc; }
        .k-row:last-child { margin-bottom: 0; }
        .k-keys { display: flex; gap: 4px; }
        .k-key { 
            background: #222; padding: 2px 8px; border-radius: 6px; font-family: monospace; 
            border: 1px solid #333; font-size: 0.75rem; color: var(--accent);
        }

        /* --- LIBRARY VIEWS --- */
        .view-layer {
            position: absolute; inset: 0; background: var(--bg-dark);
            padding: 30px; overflow-y: auto; z-index: 20;
            opacity: 0; pointer-events: none; transform: scale(0.98);
            transition: opacity 0.3s ease, transform 0.3s ease;
        }
        .view-layer.active { opacity: 1; pointer-events: auto; transform: scale(1); }

        .media-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 20px; padding-bottom: 100px;
        }
        .card {
            background: rgba(255,255,255,0.03); border-radius: 12px; overflow: hidden;
            cursor: pointer; transition: var(--trans); border: 1px solid transparent;
            position: relative;
        }
        .card:hover { transform: translateY(-4px); background: rgba(255,255,255,0.08); border-color: rgba(255,255,255,0.1); }
        .card-thumb {
            height: 100px; background: #000; position: relative;
            background-size: cover; background-position: center;
            display: flex; align-items: center; justify-content: center;
        }
        .card-info { padding: 12px; }
        .card-title { font-size: 0.85rem; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .card-meta { font-size: 0.75rem; color: var(--text-muted); margin-top: 4px; }
        
        /* --- RIGHT PANEL --- */
        .panel {
            grid-column: 3; background: var(--bg-panel); border-left: var(--border);
            display: flex; flex-direction: column; backdrop-filter: blur(20px);
        }
        .tabs { display: flex; border-bottom: var(--border); }
        .tab {
            flex: 1; padding: 16px; text-align: center; font-size: 0.85rem;
            color: var(--text-muted); cursor: pointer; position: relative;
        }
        .tab.active { color: #fff; }
        .tab.active::after { content:''; position: absolute; bottom: 0; left: 0; width: 100%; height: 2px; background: var(--accent); box-shadow: 0 0 10px var(--accent); }
        
        .panel-body { flex: 1; overflow-y: auto; padding: 0; }
        .queue-item {
            padding: 12px 20px; border-bottom: 1px solid rgba(255,255,255,0.03);
            font-size: 0.85rem; cursor: pointer; transition: 0.2s; display: flex; justify-content: space-between;
        }
        .queue-item.playing { border-left: 3px solid var(--accent); background: linear-gradient(90deg, var(--accent-dim), transparent); color: var(--accent); }

        /* Controls UI */
        .setting-group { padding: 20px; }
        input[type=range] {
            -webkit-appearance: none; width: 100%; background: transparent; margin: 10px 0;
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%; height: 4px; background: rgba(255,255,255,0.1); border-radius: 2px;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none; height: 14px; width: 14px; border-radius: 50%;
            background: #fff; margin-top: -5px; box-shadow: 0 0 10px rgba(0,0,0,0.5);
            transition: 0.2s;
        }
        input[type=range]:hover::-webkit-slider-thumb { background: var(--accent); transform: scale(1.2); }

        /* --- PLAYER BAR --- */
        .player-bar {
            grid-column: 1 / -1; background: rgba(10,10,10,0.9); border-top: var(--border);
            backdrop-filter: blur(25px); padding: 0 24px; display: flex; flex-direction: column;
            justify-content: center; z-index: 100; position: relative;
        }
        
        .progress-area {
            position: absolute; top: -8px; left: 0; width: 100%; height: 16px;
            cursor: pointer; z-index: 101; display: flex; align-items: center;
        }
        .progress-bg { width: 100%; height: 3px; background: rgba(255,255,255,0.1); transition: height 0.2s; }
        .progress-fill { height: 100%; background: var(--accent); width: 0%; box-shadow: 0 0 10px var(--accent); position: relative;}
        .progress-area:hover .progress-bg { height: 6px; }

        .controls { display: flex; align-items: center; justify-content: space-between; margin-top: 5px;}
        .ctrl-group { display: flex; align-items: center; gap: 16px; }
        
        .btn-icon {
            background: none; border: none; color: #ccc; cursor: pointer;
            width: 36px; height: 36px; border-radius: 50%; display: flex;
            align-items: center; justify-content: center; transition: 0.2s;
        }
        .btn-icon:hover { background: rgba(255,255,255,0.1); color: #fff; }
        .btn-play {
            width: 48px; height: 48px; background: #fff; color: #000;
            box-shadow: 0 0 20px rgba(255,255,255,0.3);
        }
        .btn-play:hover { transform: scale(1.05); background: var(--accent); box-shadow: 0 0 20px var(--accent); }

        /* --- UTILS --- */
        .hidden { display: none !important; }
        .toast {
            position: fixed; bottom: 110px; left: 50%; transform: translateX(-50%) translateY(20px);
            background: rgba(20, 20, 20, 0.9); border: 1px solid rgba(255,255,255,0.2);
            padding: 12px 24px; border-radius: 30px; color: #fff; pointer-events: none;
            opacity: 0; transition: 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); z-index: 1000;
            font-weight: 500; display: flex; align-items: center; gap: 10px;
        }
        .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

        @media(max-width: 900px) {
            #app { grid-template-columns: 1fr; grid-template-rows: 1fr 90px; }
            .sidebar, .panel { position: fixed; inset: 0; z-index: 200; background: #111; transform: translateX(-100%); transition: transform 0.3s; width: 85%; }
            .sidebar.open, .panel.open { transform: translateX(0); }
            .panel { right: 0; left: auto; transform: translateX(100%); width: 300px; border-left: 1px solid #333; }
            .mobile-toggle { display: block !important; }
        }
        .mobile-toggle { display: none; }
    </style>
</head>
<body>

<div id="app">
    <!-- SIDEBAR -->
    <aside class="sidebar" id="sidebar">
        <div class="logo">
            <svg viewBox="0 0 24 24" width="28" height="28"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 14.5v-9l6 4.5-6 4.5z"/></svg>
            UltraPlay OS
        </div>

        <div class="nav-item active" onclick="ui.navigate('library')">
            <svg viewBox="0 0 24 24"><path d="M4 6H2v14c0 1.1.9 2 2 2h14v-2H4V6zm16-4H8c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-1 9h-4v4h-2v-4H9V9h4V5h2v4h4v2z"/></svg>
            Library
        </div>
        <div class="nav-item" onclick="ui.navigate('player')">
            <svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
            Now Playing
        </div>
        
        <div class="sidebar-divider"></div>
        <div class="nav-item" onclick="document.getElementById('file-input').click()">
            <svg viewBox="0 0 24 24"><path d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zm2 16H8v-2h8v2zm0-4H8v-2h8v2zm-3-5V3.5L18.5 9H13z"/></svg>
            Import Files
        </div>
        <div class="nav-item btn-reset" onclick="app.reset()">
            <svg viewBox="0 0 24 24"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>
            Reset
        </div>
    </aside>

    <!-- MAIN STAGE -->
    <main class="stage" onclick="ui.toggleBars()">
        <video id="video-element" playsinline crossorigin="anonymous"></video>
        <canvas id="visualizer"></canvas>

        <!-- FLOATING SHORTCUTS PANEL (NEW) -->
        <div class="shortcuts-panel">
            <div class="shortcuts-trigger">?</div>
            <div class="shortcuts-list">
                <div class="k-row"><span>Play / Pause</span> <span class="k-key">Space</span></div>
                <div class="k-row"><span>Seek +/- 5s</span> <div class="k-keys"><span class="k-key">‚Üê</span><span class="k-key">‚Üí</span></div></div>
                <div class="k-row"><span>Volume +/-</span> <div class="k-keys"><span class="k-key">‚Üë</span><span class="k-key">‚Üì</span></div></div>
                <div class="k-row"><span>Fullscreen</span> <span class="k-key">F</span></div>
                <div class="k-row"><span>Mute</span> <span class="k-key">M</span></div>
                <hr style="border:0; border-top:1px solid #333; margin:8px 0;">
                <div class="k-row" style="color:var(--accent); font-weight:600;">NUMPAD SUPPORT</div>
                <div class="k-row"><span>Seek</span> <div class="k-keys"><span class="k-key">4</span><span class="k-key">6</span></div></div>
                <div class="k-row"><span>Volume</span> <div class="k-keys"><span class="k-key">8</span><span class="k-key">2</span></div></div>
            </div>
        </div>

        <!-- Library Overlay -->
        <div id="view-library" class="view-layer active">
            <div style="display:flex; justify-content:space-between; margin-bottom:20px;">
                <h1 style="margin:0;">Library</h1>
                <span id="lib-count" style="color:#666; align-self:center;">0 items</span>
            </div>
            
            <div id="drop-target" style="border:2px dashed rgba(255,255,255,0.1); padding:40px; text-align:center; border-radius:16px; margin-bottom:20px; color:#666;">
                Drag & Drop Media Files or Folders
            </div>

            <div class="media-grid" id="media-grid"></div>
        </div>
    </main>

    <!-- RIGHT PANEL -->
    <aside class="panel" id="right-panel">
        <div class="tabs">
            <div class="tab active" onclick="ui.switchTab('queue', this)">Queue</div>
            <div class="tab" onclick="ui.switchTab('audio', this)">Audio/Video</div>
        </div>

        <div id="tab-queue" class="panel-body">
            <div id="queue-list"></div>
        </div>

        <div id="tab-audio" class="panel-body hidden">
            <div class="setting-group">
                <div style="font-size:0.8rem; color:#888; margin-bottom:10px;">Master Volume</div>
                <input type="range" min="0" max="1" step="0.05" value="1" oninput="player.volume(this.value)">

                <div style="font-size:0.8rem; color:#888; margin-bottom:10px; margin-top:20px;">Speed</div>
                <input type="range" min="0.5" max="2.5" step="0.25" value="1" oninput="player.speed(this.value)">
                
                <div style="margin-top:25px; font-weight:700; color:var(--accent); font-size:0.8rem;">EQUALIZER</div>
                <div style="display:flex; gap:10px;">
                    <input type="range" min="-12" max="12" value="0" oninput="audio.eq('bass', this.value)" title="Bass">
                    <input type="range" min="-12" max="12" value="0" oninput="audio.eq('mid', this.value)" title="Mid">
                    <input type="range" min="-12" max="12" value="0" oninput="audio.eq('treble', this.value)" title="Treble">
                </div>
                <div style="display:flex; justify-content:space-between; font-size:0.7rem; color:#666;">
                    <span>Bass</span><span>Mid</span><span>Treb</span>
                </div>

                <button class="nav-item" style="width:100%; justify-content:center; background:rgba(255,255,255,0.05); margin-top:20px;" onclick="document.getElementById('sub-input').click()">
                    Load Subtitles
                </button>
            </div>
        </div>
    </aside>

    <!-- PLAYER BAR -->
    <div class="player-bar">
        <div class="progress-area" id="seek-bar">
            <div class="progress-bg"><div class="progress-fill" id="seek-fill"></div></div>
        </div>
        <div class="controls">
            <div class="ctrl-group">
                <button class="btn-icon" onclick="player.prev()"><svg width="24" height="24" fill="currentColor" viewBox="0 0 24 24"><path d="M6 6h2v12H6zm3.5 6l8.5 6V6z"/></svg></button>
                <button class="btn-icon btn-play" id="btn-play" onclick="player.toggle()"><svg width="32" height="32" fill="currentColor" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg></button>
                <button class="btn-icon" onclick="player.next()"><svg width="24" height="24" fill="currentColor" viewBox="0 0 24 24"><path d="M6 18l8.5-6L6 6v12zM16 6v12h2V6h-2z"/></svg></button>
                <div style="font-family:monospace; font-size:0.85rem; color:#888;" id="time-display">00:00 / 00:00</div>
            </div>
            
            <div class="ctrl-group">
                <button class="btn-icon" title="Fullscreen" onclick="player.fullscreen()"><svg width="24" height="24" fill="currentColor" viewBox="0 0 24 24"><path d="M7 14H5v5h5v-2H7v-3zm-2-4h2V7h3V5H5v5zm12 7h-3v2h5v-5h-2v3zM14 5v2h3v3h2V5h-5z"/></svg></button>
                <button class="btn-icon mobile-toggle" onclick="document.getElementById('right-panel').classList.toggle('open')"><svg width="24" height="24" fill="currentColor" viewBox="0 0 24 24"><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg></button>
            </div>
        </div>
    </div>
</div>

<div id="toast" class="toast"><span id="toast-msg">Notification</span></div>

<input type="file" id="file-input" multiple accept="video/*,audio/*" class="hidden">
<input type="file" id="sub-input" accept=".srt,.vtt" class="hidden">

<script>
/** ULTRA PLAY OS v3.1 CORE **/

const $ = (s) => document.querySelector(s);
const $$ = (s) => document.querySelectorAll(s);
const Utils = {
    uuid: () => Math.random().toString(36).substr(2, 9),
    fmtTime: (s) => {
        if (!s || isNaN(s)) return "00:00";
        let m = Math.floor(s / 60), sec = Math.floor(s % 60);
        let h = Math.floor(m / 60); m = m % 60;
        return (h>0 ? h+':' : '') + (m<10?'0'+m:m) + ':' + (sec<10?'0'+sec:sec);
    },
    srtToVtt: (srt) => "WEBVTT\n\n" + srt.replace(/(\d{2}):(\d{2}):(\d{2}),(\d{3})/g, '$1:$2:$3.$4')
};

class Database {
    constructor() {
        this.conn = new Promise((resolve) => {
            const req = indexedDB.open('UltraPlayDB_v3', 1);
            req.onupgradeneeded = e => {
                const db = e.target.result;
                if (!db.objectStoreNames.contains('library')) db.createObjectStore('library', { keyPath: 'id' });
            };
            req.onsuccess = e => resolve(e.target.result);
        });
    }
    async add(files) {
        const db = await this.conn;
        const tx = db.transaction('library', 'readwrite');
        const store = tx.objectStore('library');
        for (const file of files) {
            if(!file.type.match(/^(video|audio)/)) continue;
            store.add({ id: Utils.uuid(), name: file.name, type: file.type, blob: file, size: file.size, thumb: null });
        }
        return new Promise(r => tx.oncomplete = r);
    }
    async getAll() {
        const db = await this.conn;
        return new Promise(r => db.transaction('library').objectStore('library').getAll().onsuccess = e => r(e.target.result));
    }
    async update(data) { (await this.conn).transaction('library', 'readwrite').objectStore('library').put(data); }
    async wipe() { indexedDB.deleteDatabase('UltraPlayDB_v3'); location.reload(); }
}

class ThumbEngine {
    constructor() {
        this.queue = []; this.active = false;
        this.canvas = document.createElement('canvas');
        this.canvas.width = 160; this.canvas.height = 90;
        this.ctx = this.canvas.getContext('2d');
    }
    add(item) { if(!item.type.startsWith('audio')) { this.queue.push(item); this.process(); } }
    async process() {
        if (this.active || !this.queue.length) return;
        this.active = true;
        const item = this.queue.shift();
        try {
            const vid = document.createElement('video');
            vid.src = URL.createObjectURL(item.blob);
            vid.currentTime = 5; vid.muted = true;
            await new Promise(r => {
                vid.onseeked = () => {
                    this.ctx.drawImage(vid, 0, 0, 160, 90);
                    item.thumb = this.canvas.toDataURL('image/jpeg', 0.6);
                    db.update(item); ui.updateThumb(item.id, item.thumb);
                    URL.revokeObjectURL(vid.src); r();
                };
                vid.onerror = r; vid.load();
            });
        } catch(e) {}
        this.active = false; setTimeout(() => this.process(), 50);
    }
}

class AudioVis {
    constructor(video) {
        this.v = video; this.ctx = new (window.AudioContext || window.webkitAudioContext)();
        this.src = this.ctx.createMediaElementSource(this.v);
        this.bands = { bass: this.cF('lowshelf',100), mid: this.cF('peaking',1000), treble: this.cF('highshelf',3000) };
        this.analyser = this.ctx.createAnalyser(); this.analyser.fftSize = 128;
        this.src.connect(this.bands.bass); this.bands.bass.connect(this.bands.mid);
        this.bands.mid.connect(this.bands.treble); this.bands.treble.connect(this.analyser);
        this.analyser.connect(this.ctx.destination);
        this.render();
    }
    cF(t, f) { const n = this.ctx.createBiquadFilter(); n.type=t; n.frequency.value=f; return n; }
    eq(b, v) { if(this.bands[b]) this.bands[b].gain.value = v; }
    render() {
        const cvs = $('#visualizer'), ctx = cvs.getContext('2d');
        const draw = () => {
            requestAnimationFrame(draw);
            if(this.v.paused) return;
            if(cvs.width !== cvs.offsetWidth) { cvs.width = cvs.offsetWidth; cvs.height = cvs.offsetHeight; }
            const d = new Uint8Array(this.analyser.frequencyBinCount);
            this.analyser.getByteFrequencyData(d);
            ctx.clearRect(0,0,cvs.width,cvs.height);
            const w=cvs.width, h=cvs.height, bw=(w/d.length)*2.5;
            ctx.fillStyle = '#00f2ff';
            for(let i=0; i<d.length; i++) {
                const bh = (d[i]/255)*h;
                ctx.fillRect(w/2 + i*bw, h-bh, bw-1, bh);
                ctx.fillRect(w/2 - i*bw, h-bh, bw-1, bh);
            }
        };
        draw();
    }
    resume() { if(this.ctx.state === 'suspended') this.ctx.resume(); }
}

class Player {
    constructor() {
        this.v = $('#video-element'); this.queue = []; this.index = 0;
        this.v.ontimeupdate = () => this.tick();
        this.v.onended = () => this.next();
    }
    load(media) {
        this.v.src = URL.createObjectURL(media.blob);
        this.v.play().catch(()=>{});
        $('#visualizer').style.display = media.type.startsWith('audio') ? 'block' : 'none';
        if(audio) audio.resume();
        ui.highlight(this.index); ui.navigate('player');
    }
    playList(list, idx) { this.queue = list; this.index = idx; ui.renderQueue(list); this.load(this.queue[this.index]); }
    toggle() { this.v.paused ? this.v.play() : this.v.pause(); this.updateBtn(); }
    next() { if(this.index < this.queue.length-1) { this.index++; this.load(this.queue[this.index]); }}
    prev() { if(this.index > 0) { this.index--; this.load(this.queue[this.index]); }}
    seek(pct) { if(this.v.duration) this.v.currentTime = this.v.duration * pct; }
    volume(v) { this.v.volume = v; }
    speed(s) { this.v.playbackRate = s; }
    fullscreen() { document.fullscreenElement ? document.exitFullscreen() : document.body.requestFullscreen(); }
    tick() {
        $('#seek-fill').style.width = ((this.v.currentTime/this.v.duration)*100||0) + '%';
        $('#time-display').innerText = `${Utils.fmtTime(this.v.currentTime)} / ${Utils.fmtTime(this.v.duration)}`;
        this.updateBtn();
    }
    updateBtn() { $('#btn-play').innerHTML = this.v.paused ? '<svg width="32" height="32" fill="currentColor" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>' : '<svg width="32" height="32" fill="currentColor" viewBox="0 0 24 24"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>'; }
}

class UI {
    constructor() {
        this.initDrag(); this.initSeek(); this.initKeys();
    }
    navigate(view) {
        $$('.view-layer').forEach(e => e.classList.remove('active'));
        $$('.nav-item').forEach(e => e.classList.remove('active'));
        if(view === 'library') { $('#view-library').classList.add('active'); $$('.nav-item')[0].classList.add('active'); }
        else { $$('.nav-item')[1].classList.add('active'); }
        $('#sidebar').classList.remove('open');
    }
    switchTab(id, el) {
        $$('.panel-body').forEach(e => e.classList.add('hidden'));
        $$('.tab').forEach(e => e.classList.remove('active'));
        $(`#tab-${id}`).classList.remove('hidden'); el.classList.add('active');
    }
    async renderLib() {
        const items = await db.getAll();
        const grid = $('#media-grid'); grid.innerHTML = '';
        $('#lib-count').innerText = `${items.length} items`;
        items.forEach(item => {
            const el = document.createElement('div'); el.className = 'card'; el.id = `c-${item.id}`;
            el.innerHTML = `<div class="card-thumb" style="background-image:url('${item.thumb||''}')">${!item.thumb?(item.type.startsWith('audio')?'üéµ':'üé¨'):''}</div><div class="card-info"><div class="card-title">${item.name}</div><div class="card-meta">${(item.size/1024/1024).toFixed(1)}MB</div></div>`;
            el.onclick = () => player.playList(items, items.indexOf(item));
            grid.appendChild(el);
            if(!item.thumb && item.type.startsWith('video')) thumbs.add(item);
        });
    }
    renderQueue(list) {
        const q = $('#queue-list'); q.innerHTML = '';
        list.forEach((item, i) => {
            const div = document.createElement('div'); div.className = 'queue-item'; div.id = `q-${i}`;
            div.innerHTML = `<span>${i+1}. ${item.name}</span>`;
            div.onclick = () => { player.index = i; player.load(item); };
            q.appendChild(div);
        });
    }
    highlight(idx) { $$('.queue-item').forEach(e => e.classList.remove('playing')); const el = $(`#q-${idx}`); if(el) el.classList.add('playing'); }
    updateThumb(id, url) { const el = $(`#c-${id} .card-thumb`); if(el) { el.style.backgroundImage = `url('${url}')`; el.innerText = ''; }}
    toast(msg) { const t = $('#toast'); $('#toast-msg').innerText = msg; t.classList.add('show'); setTimeout(() => t.classList.remove('show'), 2000); }
    toggleBars() { $('.player-bar').style.transform = $('.player-bar').style.transform ? '' : 'translateY(100%)'; }
    initDrag() {
        const t = $('#drop-target');
        ['dragenter','dragover','dragleave','drop'].forEach(ev => t.addEventListener(ev, async e => {
            e.preventDefault();
            if(e.type === 'drop') {
                await db.add([...e.dataTransfer.files]); this.renderLib();
            }
        }));
        $('#file-input').onchange = (e) => { db.add([...e.target.files]).then(() => this.renderLib()); };
    }
    initSeek() { $('#seek-bar').onclick = e => { const r = $('#seek-bar').getBoundingClientRect(); player.seek((e.clientX - r.left) / r.width); }; }
    
    // --- UPDATED KEYBOARD LOGIC (NUMPAD ADDED) ---
    initKeys() {
        document.addEventListener('keydown', e => {
            if(e.target.tagName === 'INPUT') return;
            
            // Map standard keys and Numpad keys
            const isUp = e.code === 'ArrowUp' || e.code === 'Numpad8';
            const isDown = e.code === 'ArrowDown' || e.code === 'Numpad2';
            const isLeft = e.code === 'ArrowLeft' || e.code === 'Numpad4';
            const isRight = e.code === 'ArrowRight' || e.code === 'Numpad6';
            const isSpace = e.code === 'Space' || e.code === 'Numpad5'; // Optional: Numpad 5 as play/pause

            if (isSpace) { e.preventDefault(); player.toggle(); }
            else if (isRight) player.v.currentTime += 5;
            else if (isLeft) player.v.currentTime -= 5;
            else if (isUp) player.v.volume = Math.min(1, player.v.volume + 0.1);
            else if (isDown) player.v.volume = Math.max(0, player.v.volume - 0.1);
            else if (e.code === 'KeyF') player.fullscreen();
            else if (e.code === 'KeyM') player.v.muted = !player.v.muted;
        });

        $('#sub-input').onchange = e => {
            const r = new FileReader();
            r.onload = v => {
                let txt = v.target.result; if(e.target.files[0].name.endsWith('.srt')) txt = Utils.srtToVtt(txt);
                const blob = new Blob([txt], {type:'text/vtt'});
                const t = document.createElement('track'); t.kind='subtitles'; t.src=URL.createObjectURL(blob); t.default=true;
                player.v.innerHTML = ''; player.v.appendChild(t); ui.toast("Subtitles Loaded");
            };
            r.readAsText(e.target.files[0]);
        };
    }
}

const db = new Database(); const thumbs = new ThumbEngine(); const ui = new UI(); const player = new Player(); let audio;
const app = { reset: async () => { if(confirm("Wipe data?")) await db.wipe(); } };

(async () => { await ui.renderLib(); document.body.addEventListener('click', () => { if(!audio) audio = new AudioVis($('#video-element')); }, {once:true}); })();
</script>
</body>
</html>