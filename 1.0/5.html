<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UltraPlay OS v3.0 - Ultimate</title>
    <meta name="theme-color" content="#050505">
    <style>
        /* --- THEME ENGINE --- */
        :root {
            --bg-base: #050505;
            --bg-panel: rgba(18, 18, 18, 0.85);
            --surface: rgba(255, 255, 255, 0.05);
            --surface-hover: rgba(255, 255, 255, 0.1);
            --accent: #00f2ff;
            --accent-glow: rgba(0, 242, 255, 0.4);
            --text-main: #ffffff;
            --text-muted: #a0a0a0;
            --border: 1px solid rgba(255, 255, 255, 0.08);
            --backdrop: blur(20px);
            --font: 'Segoe UI', 'Inter', system-ui, sans-serif;
            --radius: 12px;
            --ambient-color: #000; /* Dynamic Variable */
        }

        [data-theme="light"] {
            --bg-base: #f0f2f5;
            --bg-panel: rgba(255, 255, 255, 0.85);
            --surface: rgba(0, 0, 0, 0.05);
            --surface-hover: rgba(0, 0, 0, 0.1);
            --accent: #007bff;
            --accent-glow: rgba(0, 123, 255, 0.3);
            --text-main: #1a1a1a;
            --text-muted: #666;
            --border: 1px solid rgba(0, 0, 0, 0.08);
            --ambient-color: #fff;
        }

        /* --- GLOBAL RESET --- */
        * { box-sizing: border-box; outline: none; user-select: none; -webkit-tap-highlight-color: transparent; }
        body { 
            margin: 0; font-family: var(--font); background: var(--bg-base);
            color: var(--text-main); height: 100vh; overflow: hidden; 
            transition: background 0.5s;
        }
        /* Dynamic Ambient Background */
        body::before {
            content: ''; position: absolute; inset: -50%; width: 200%; height: 200%;
            background: radial-gradient(circle at 50% 50%, var(--ambient-color), transparent 60%);
            opacity: 0.15; z-index: -1; transition: background 1s ease; pointer-events: none;
        }

        ::-webkit-scrollbar { width: 5px; height: 5px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(128,128,128,0.3); border-radius: 4px; }
        
        /* --- LAYOUT --- */
        #app { display: grid; grid-template-columns: 260px 1fr 320px; grid-template-rows: 1fr 90px; height: 100%; }

        /* --- SIDEBAR --- */
        .sidebar {
            background: var(--bg-panel); border-right: var(--border); padding: 20px 14px;
            display: flex; flex-direction: column; gap: 6px; backdrop-filter: var(--backdrop); z-index: 50;
        }
        .logo { font-size: 1.2rem; font-weight: 800; color: var(--text-main); display: flex; align-items: center; gap: 10px; margin-bottom: 20px; padding: 0 10px; letter-spacing: -0.5px; }
        .logo svg { filter: drop-shadow(0 0 8px var(--accent)); color: var(--accent); }
        
        .nav-btn {
            padding: 10px 14px; border-radius: var(--radius); cursor: pointer; color: var(--text-muted);
            display: flex; align-items: center; gap: 12px; font-size: 0.9rem; font-weight: 600; transition: 0.2s;
        }
        .nav-btn:hover { background: var(--surface-hover); color: var(--text-main); transform: translateX(2px); }
        .nav-btn.active { background: rgba(0, 242, 255, 0.1); color: var(--accent); }
        [data-theme="light"] .nav-btn.active { background: rgba(0, 123, 255, 0.1); }
        .nav-header { font-size: 0.7rem; font-weight: 800; color: var(--text-muted); margin: 20px 0 5px 14px; text-transform: uppercase; letter-spacing: 1px; }

        /* --- STAGE (CENTER) --- */
        .stage { grid-column: 2; position: relative; background: #000; display: flex; align-items: center; justify-content: center; overflow: hidden; }
        video { width: 100%; height: 100%; object-fit: contain; z-index: 1; outline: none; }
        
        /* Subtitle Styling */
        video::cue { background: rgba(0,0,0,0.6); color: #fff; font-family: var(--font); border-radius: 4px; }
        
        #visualizer { position: absolute; bottom: 0; left: 0; width: 100%; height: 150px; z-index: 2; pointer-events: none; opacity: 0.7; mix-blend-mode: screen; }

        /* --- LIBRARY VIEW --- */
        .library-overlay {
            position: absolute; inset: 0; background: var(--bg-base); z-index: 10; padding: 30px; 
            overflow-y: auto; display: none; animation: fadeIn 0.3s ease;
        }
        .library-overlay.active { display: block; }
        .lib-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; gap: 15px; }
        .search-box {
            flex: 1; max-width: 400px; background: var(--surface); border: var(--border);
            padding: 10px 15px; border-radius: 50px; color: var(--text-main); font-family: inherit;
        }
        .filter-pill {
            padding: 6px 14px; background: var(--surface); border-radius: 20px; font-size: 0.8rem; 
            cursor: pointer; transition: 0.2s; border: 1px solid transparent;
        }
        .filter-pill.active { background: var(--accent); color: #000; font-weight: bold; }

        .media-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 20px; padding-bottom: 60px; }
        .card {
            background: var(--surface); border-radius: var(--radius); overflow: hidden; cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s; position: relative; border: 1px solid transparent;
        }
        .card:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.3); border-color: var(--accent); }
        .card-thumb {
            height: 100px; background: #111; background-size: cover; background-position: center;
            display: flex; align-items: center; justify-content: center; position: relative;
        }
        .card-info { padding: 12px; }
        .card-title { font-size: 0.85rem; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .card-meta { font-size: 0.75rem; color: var(--text-muted); margin-top: 4px; display: flex; justify-content: space-between; }
        .fav-icon { position: absolute; top: 5px; right: 5px; opacity: 0; transition: 0.2s; background: rgba(0,0,0,0.5); border-radius: 50%; padding: 4px; }
        .card:hover .fav-icon, .card.favorite .fav-icon { opacity: 1; }
        .card.favorite .fav-icon svg { fill: #ff4757; color: #ff4757; }

        /* --- RIGHT PANEL --- */
        .right-panel {
            background: var(--bg-panel); border-left: var(--border); backdrop-filter: var(--backdrop);
            display: flex; flex-direction: column; z-index: 50;
        }
        .tabs { display: flex; padding: 10px; gap: 5px; }
        .tab { flex: 1; text-align: center; padding: 8px; font-size: 0.8rem; font-weight: 600; color: var(--text-muted); border-radius: 6px; cursor: pointer; }
        .tab.active { background: var(--surface); color: var(--text-main); }
        
        .panel-content { flex: 1; overflow-y: auto; padding: 0 0 20px 0; display: none; }
        .panel-content.show { display: block; }

        /* Queue Items */
        .q-item {
            padding: 10px 15px; border-bottom: 1px solid rgba(255,255,255,0.03); display: flex; align-items: center; gap: 10px;
            cursor: pointer; font-size: 0.85rem; transition: 0.2s;
        }
        .q-item:hover { background: var(--surface-hover); }
        .q-item.active { background: rgba(0, 242, 255, 0.1); border-left: 3px solid var(--accent); }
        
        /* Controls UI */
        .ctl-group { padding: 20px; border-bottom: var(--border); }
        .ctl-head { font-size: 0.7rem; font-weight: 800; color: var(--accent); letter-spacing: 1px; margin-bottom: 15px; text-transform: uppercase; }
        .range-wrap { display: flex; align-items: center; gap: 10px; margin-bottom: 12px; font-size: 0.8rem; color: var(--text-muted); }
        input[type="range"] {
            flex: 1; -webkit-appearance: none; background: rgba(128,128,128,0.2); height: 4px; border-radius: 2px;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none; width: 12px; height: 12px; background: var(--text-main); border-radius: 50%; cursor: pointer; transition: 0.2s;
        }
        input[type="range"]:hover::-webkit-slider-thumb { transform: scale(1.3); background: var(--accent); }

        /* --- PLAYER BAR --- */
        .player-bar {
            grid-column: 1 / -1; background: var(--bg-panel); border-top: var(--border);
            display: flex; flex-direction: column; justify-content: center; padding: 0 20px;
            backdrop-filter: blur(30px); z-index: 100; position: relative;
        }
        .progress-area {
            position: absolute; top: -8px; left: 0; width: 100%; height: 16px; cursor: pointer; display: flex; align-items: center;
        }
        .progress-bg { width: 100%; height: 3px; background: rgba(255,255,255,0.1); transition: height 0.2s; }
        .progress-fill { height: 100%; background: var(--accent); width: 0%; position: relative; box-shadow: 0 0 10px var(--accent); }
        .progress-area:hover .progress-bg { height: 5px; }

        .controls { display: flex; align-items: center; justify-content: space-between; height: 100%; }
        .btn {
            background: none; border: none; color: var(--text-muted); cursor: pointer; width: 36px; height: 36px;
            border-radius: 50%; display: flex; align-items: center; justify-content: center; transition: 0.2s;
        }
        .btn:hover { color: var(--text-main); background: var(--surface); }
        .btn.active { color: var(--accent); }
        .btn-lg { width: 48px; height: 48px; background: var(--text-main); color: var(--bg-base); margin: 0 10px; }
        .btn-lg:hover { transform: scale(1.1); background: var(--accent); box-shadow: 0 0 15px var(--accent-glow); }

        /* --- CONTEXT MENU --- */
        .ctx-menu {
            position: fixed; background: rgba(20,20,20,0.95); border: 1px solid #333; border-radius: 8px;
            padding: 5px 0; width: 180px; z-index: 1000; display: none; backdrop-filter: blur(10px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        .ctx-item { padding: 8px 15px; font-size: 0.85rem; color: #fff; cursor: pointer; display: flex; justify-content: space-between; }
        .ctx-item:hover { background: var(--accent); color: #000; }
        .ctx-sep { height: 1px; background: #333; margin: 4px 0; }

        /* --- TOAST --- */
        .toast {
            position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%) translateY(20px);
            background: rgba(10,10,10,0.9); border: 1px solid #333; color: #fff; padding: 10px 24px;
            border-radius: 50px; opacity: 0; transition: 0.3s; pointer-events: none; z-index: 200; font-weight: 500;
        }
        .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

<div id="app">
    <!-- SIDEBAR -->
    <aside class="sidebar">
        <div class="logo">
            <svg width="24" height="24" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 14.5v-9l6 4.5-6 4.5z"/></svg>
            UltraPlay OS
        </div>
        
        <div class="nav-header">Browse</div>
        <div class="nav-btn active" onclick="app.ui.view('library')">
            <svg width="18" height="18" fill="currentColor" viewBox="0 0 24 24"><path d="M4 6H2v14c0 1.1.9 2 2 2h14v-2H4V6zm16-4H8c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-1 9h-4v4h-2v-4H9V9h4V5h2v4h4v2z"/></svg>
            Full Library
        </div>
        <div class="nav-btn" onclick="app.ui.filterLibrary('favorites')">
            <svg width="18" height="18" fill="currentColor" viewBox="0 0 24 24"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>
            Favorites
        </div>

        <div class="nav-header">System</div>
        <div class="nav-btn" onclick="document.getElementById('import-input').click()">Import Media</div>
        <div class="nav-btn" onclick="app.toggleTheme()">Toggle Theme</div>
        <div class="nav-btn" onclick="app.db.wipe()" style="color: #ff4757;">Reset Database</div>
    </aside>

    <!-- STAGE -->
    <main class="stage">
        <video id="video-main" playsinline crossorigin="anonymous"></video>
        <canvas id="visualizer"></canvas>

        <div id="library-view" class="library-overlay active">
            <div class="lib-header">
                <input type="text" class="search-box" placeholder="Search files..." oninput="app.ui.filterLibrary(this.value)">
                <div style="display:flex; gap:10px;">
                    <div class="filter-pill active" onclick="app.ui.sort('date')">Date</div>
                    <div class="filter-pill" onclick="app.ui.sort('name')">Name</div>
                    <div class="filter-pill" onclick="app.ui.sort('size')">Size</div>
                </div>
            </div>
            <div id="grid-container" class="media-grid"></div>
        </div>

        <div id="toast-msg" class="toast">Notification</div>
    </main>

    <!-- RIGHT PANEL -->
    <aside class="right-panel">
        <div class="tabs">
            <div class="tab active" onclick="app.ui.tab('queue')">Queue</div>
            <div class="tab" onclick="app.ui.tab('audio')">Audio</div>
            <div class="tab" onclick="app.ui.tab('video')">Video</div>
        </div>

        <div id="tab-queue" class="panel-content show">
            <div style="padding:15px; font-size:0.8rem; color:#666; display:flex; justify-content:space-between;">
                <span id="queue-count">0 items</span>
                <span style="cursor:pointer; color:var(--accent);" onclick="app.player.clearQueue()">Clear</span>
            </div>
            <div id="queue-list"></div>
        </div>

        <div id="tab-audio" class="panel-content">
            <div class="ctl-group">
                <div class="ctl-head">Master</div>
                <div class="range-wrap"><span>Vol</span> <input type="range" max="100" value="100" oninput="app.player.setVol(this.value)"></div>
                <div class="range-wrap"><span>Spd</span> <input type="range" min="50" max="200" value="100" oninput="app.player.setSpeed(this.value)"></div>
            </div>
            <div class="ctl-group">
                <div class="ctl-head">Spatial Audio (Pan)</div>
                <div class="range-wrap"><span>L</span> <input type="range" min="-1" max="1" step="0.1" value="0" oninput="app.audio.setPan(this.value)"> <span>R</span></div>
            </div>
            <div class="ctl-group">
                <div class="ctl-head">Equalizer</div>
                <div class="range-wrap"><span>Bass</span> <input type="range" min="-10" max="10" value="0" oninput="app.audio.eq('low', this.value)"></div>
                <div class="range-wrap"><span>Mid</span> <input type="range" min="-10" max="10" value="0" oninput="app.audio.eq('mid', this.value)"></div>
                <div class="range-wrap"><span>Treb</span> <input type="range" min="-10" max="10" value="0" oninput="app.audio.eq('high', this.value)"></div>
                <div style="display:flex; gap:5px; margin-top:10px;">
                    <button class="filter-pill" onclick="app.audio.preset('flat')">Flat</button>
                    <button class="filter-pill" onclick="app.audio.preset('bass')">Bass</button>
                    <button class="filter-pill" onclick="app.audio.preset('vocal')">Vocal</button>
                </div>
            </div>
        </div>

        <div id="tab-video" class="panel-content">
            <div class="ctl-group">
                <div class="ctl-head">Filters</div>
                <div class="range-wrap"><span>Bright</span> <input type="range" min="50" max="150" value="100" oninput="app.player.filter('brightness', this.value+'%')"></div>
                <div class="range-wrap"><span>Contr</span> <input type="range" min="50" max="150" value="100" oninput="app.player.filter('contrast', this.value+'%')"></div>
                <div class="range-wrap"><span>Sat</span> <input type="range" min="0" max="200" value="100" oninput="app.player.filter('saturate', this.value+'%')"></div>
                <div class="range-wrap"><span>Hue</span> <input type="range" min="0" max="360" value="0" oninput="app.player.filter('hue-rotate', this.value+'deg')"></div>
            </div>
            <div class="ctl-group">
                <div class="ctl-head">Subtitles</div>
                <button class="nav-btn" style="width:100%; justify-content:center; background:#333; color:#fff;" onclick="document.getElementById('sub-input').click()">Load .SRT / .VTT</button>
                <div style="margin-top:10px;">
                    <span style="font-size:0.75rem; color:#888;">Size</span>
                    <input type="range" min="12" max="40" value="20" style="width:100%" oninput="app.player.subStyle('fontSize', this.value+'px')">
                </div>
            </div>
        </div>
    </aside>

    <!-- PLAYER BAR -->
    <div class="player-bar">
        <div class="progress-area" id="seek-bar">
            <div class="progress-bg"><div class="progress-fill" id="seek-fill"></div></div>
        </div>
        <div class="controls">
            <!-- Left Info -->
            <div style="width: 250px; overflow: hidden;">
                <div id="np-name" style="font-size: 0.9rem; font-weight: 700; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">No Media</div>
                <div id="np-time" style="font-size: 0.75rem; color: var(--text-muted); font-family: monospace;">00:00 / 00:00</div>
            </div>

            <!-- Center Controls -->
            <div style="display: flex; align-items: center; gap: 10px;">
                <button class="btn" onclick="app.player.toggleShuffle()" title="Shuffle" id="btn-shuffle"><svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M10.59 9.17L5.41 4 4 5.41l5.17 5.17 1.42-1.41zM14.5 4l2.04 2.04L4 18.59 5.41 20 17.96 7.46 20 9.5V4h-5.5zm.33 9.41l-1.41 1.41 3.13 3.13L14.5 20H20v-5.5l-2.04 2.04-3.13-3.13z"/></svg></button>
                <button class="btn" onclick="app.player.prev()"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M6 6h2v12H6zm3.5 6l8.5 6V6z"/></svg></button>
                <button class="btn btn-lg" onclick="app.player.togglePlay()" id="btn-play"><svg width="32" height="32" viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg></button>
                <button class="btn" onclick="app.player.next()"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M6 18l8.5-6L6 6v12zM16 6v12h2V6h-2z"/></svg></button>
                <button class="btn" onclick="app.player.toggleLoop()" title="Loop" id="btn-loop"><svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M12 4V1L8 5l4 4V6c3.31 0 6 2.69 6 6 0 1.01-.25 1.97-.7 2.8l1.46 1.46C19.54 15.03 20 13.57 20 12c0-4.42-3.58-8-8-8zm0 14c-3.31 0-6-2.69-6-6 0-1.01.25-1.97.7-2.8L5.24 7.74C4.46 8.97 4 10.43 4 12c0 4.42 3.58 8 8 8v3l4-4-4-4v3z"/></svg></button>
            </div>

            <!-- Right Tools -->
            <div style="width: 250px; display: flex; justify-content: flex-end; gap: 5px;">
                <button class="btn" onclick="app.player.toggleMute()"><svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02z"/></svg></button>
                <button class="btn" onclick="app.player.togglePiP()"><svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M19 11h-8v6h8v-6zm4 8V4.98C23 3.88 22.1 3 21 3H3c-1.1 0-2 .88-2 1.98V19c0 1.1.9 2 2 2h18c1.1 0 2-.9 2-2zm-2 .02H3V4.97h18v14.05z"/></svg></button>
                <button class="btn" onclick="app.player.toggleFull()"><svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M7 14H5v5h5v-2H7v-3zm-2-4h2V7h3V5H5v5zm12 7h-3v2h5v-5h-2v3zM14 5v2h3v3h2V5h-5z"/></svg></button>
            </div>
        </div>
    </div>

    <!-- Hidden Inputs/Menus -->
    <input type="file" id="import-input" multiple accept="video/*,audio/*" style="display:none">
    <input type="file" id="sub-input" accept=".srt,.vtt" style="display:none">
    
    <div id="ctx-menu" class="ctx-menu">
        <div class="ctx-item" onclick="app.ctxAction('play')">Play Now</div>
        <div class="ctx-item" onclick="app.ctxAction('next')">Play Next</div>
        <div class="ctx-item" onclick="app.ctxAction('queue')">Add to Queue</div>
        <div class="ctx-sep"></div>
        <div class="ctx-item" onclick="app.ctxAction('fav')">Toggle Favorite</div>
        <div class="ctx-item" style="color:#ff4757" onclick="app.ctxAction('delete')">Delete</div>
    </div>
</div>

<script>
/**
 * ULTRA PLAY OS v3.0 CORE
 */

// --- UTILS ---
const $ = (s) => document.querySelector(s);
const uuid = () => Math.random().toString(36).substr(2, 9);
const formatTime = s => {
    if(!s || isNaN(s)) return "00:00";
    let m = Math.floor(s/60), sec = Math.floor(s%60);
    return `${m < 10 ? '0'+m : m}:${sec < 10 ? '0'+sec : sec}`;
};

// --- DATABASE (IndexedDB) ---
class DB {
    constructor() { this.db = null; this.ready = this.init(); }
    init() {
        return new Promise(r => {
            const req = indexedDB.open('UltraPlayDB', 2);
            req.onupgradeneeded = e => {
                const db = e.target.result;
                if(!db.objectStoreNames.contains('media')) db.createObjectStore('media', { keyPath: 'id' });
            };
            req.onsuccess = e => { this.db = e.target.result; r(); };
        });
    }
    async add(file) {
        await this.ready;
        const item = { 
            id: uuid(), name: file.name, type: file.type, size: file.size, 
            blob: file, date: Date.now(), fav: false, thumb: null 
        };
        this.db.transaction('media', 'readwrite').objectStore('media').add(item);
        return item;
    }
    async get(id) { await this.ready; return new Promise(r => this.db.transaction('media').objectStore('media').get(id).onsuccess = e => r(e.target.result)); }
    async getAll() { await this.ready; return new Promise(r => this.db.transaction('media').objectStore('media').getAll().onsuccess = e => r(e.target.result)); }
    async update(item) { await this.ready; this.db.transaction('media', 'readwrite').objectStore('media').put(item); }
    async delete(id) { await this.ready; this.db.transaction('media', 'readwrite').objectStore('media').delete(id); }
    async wipe() { indexedDB.deleteDatabase('UltraPlayDB'); location.reload(); }
}

// --- AUDIO ENGINE (Web Audio API) ---
class AudioFX {
    constructor(video) {
        this.v = video;
        this.ctx = new (window.AudioContext || window.webkitAudioContext)();
        this.src = this.ctx.createMediaElementSource(this.v);
        
        // Nodes
        this.panner = this.ctx.createStereoPanner();
        this.gain = this.ctx.createGain();
        this.bands = {
            low: this.ctx.createBiquadFilter(),
            mid: this.ctx.createBiquadFilter(),
            high: this.ctx.createBiquadFilter()
        };
        this.analyser = this.ctx.createAnalyser();

        // Config Nodes
        this.bands.low.type = 'lowshelf'; this.bands.low.frequency.value = 320;
        this.bands.mid.type = 'peaking'; this.bands.mid.frequency.value = 1000;
        this.bands.high.type = 'highshelf'; this.bands.high.frequency.value = 3200;
        this.analyser.fftSize = 128;

        // Connect Graph
        this.src.connect(this.bands.low)
            .connect(this.bands.mid)
            .connect(this.bands.high)
            .connect(this.panner)
            .connect(this.gain)
            .connect(this.analyser)
            .connect(this.ctx.destination);
            
        this.renderVisualizer();
    }
    eq(band, val) { this.bands[band].gain.value = val; }
    preset(type) {
        const p = { flat:[0,0,0], bass:[8,2,-2], vocal:[-2,6,2] }[type];
        ['low','mid','high'].forEach((k,i) => {
            this.bands[k].gain.value = p[i];
            // Update UI sliders manually if needed, simplified here
        });
        app.ui.toast(`EQ: ${type.toUpperCase()}`);
    }
    setPan(val) { this.panner.pan.value = val; }
    
    renderVisualizer() {
        const cvs = $('#visualizer'), ctx = cvs.getContext('2d');
        const buffer = new Uint8Array(this.analyser.frequencyBinCount);
        const loop = () => {
            requestAnimationFrame(loop);
            if(this.v.paused) return;
            cvs.width = cvs.offsetWidth; cvs.height = cvs.offsetHeight;
            this.analyser.getByteFrequencyData(buffer);
            ctx.clearRect(0,0,cvs.width,cvs.height);
            const barW = (cvs.width / buffer.length) * 2.5;
            let x = 0;
            for(let i=0; i<buffer.length; i++) {
                const h = (buffer[i]/255)*cvs.height;
                ctx.fillStyle = `rgba(0,242,255,${buffer[i]/300})`;
                ctx.fillRect(x, cvs.height - h, barW, h);
                x += barW + 2;
            }
        };
        loop();
    }
}

// --- THUMBNAIL GENERATOR (Lazy Load) ---
const thumbObserver = new IntersectionObserver((entries) => {
    entries.forEach(async entry => {
        if(entry.isIntersecting) {
            const el = entry.target, id = el.dataset.id;
            const item = await app.db.get(id);
            if(item && !item.thumb && item.type.startsWith('video')) {
                // Generate
                const v = document.createElement('video');
                v.src = URL.createObjectURL(item.blob);
                v.currentTime = 5;
                v.muted = true;
                v.onseeked = () => {
                    const c = document.createElement('canvas');
                    c.width = 320; c.height = 180;
                    c.getContext('2d').drawImage(v,0,0,c.width,c.height);
                    item.thumb = c.toDataURL('image/jpeg', 0.5);
                    app.db.update(item);
                    el.style.backgroundImage = `url(${item.thumb})`;
                    URL.revokeObjectURL(v.src);
                };
            }
            thumbObserver.unobserve(el);
        }
    });
}, { root: $('#library-view'), threshold: 0.1 });

// --- MAIN APPLICATION ---
class App {
    constructor() {
        this.db = new DB();
        this.ui = new UI(this);
        this.player = new Player(this);
        this.audio = null; // Init on first user interaction
        
        // Global Events
        $('#import-input').onchange = e => this.importFiles(e.target.files);
        $('#sub-input').onchange = e => this.player.loadSubs(e.target.files[0]);
        
        // Theme
        if(localStorage.getItem('theme') === 'light') document.body.setAttribute('data-theme', 'light');
        
        // Init
        (async () => { await this.db.ready; this.ui.renderLibrary(); })();
    }

    async importFiles(files) {
        this.ui.toast(`Importing ${files.length} files...`);
        for(let f of files) await this.db.add(f);
        this.ui.renderLibrary();
        this.ui.toast("Import Complete");
    }

    toggleTheme() {
        const isLight = document.body.getAttribute('data-theme') === 'light';
        document.body.setAttribute('data-theme', isLight ? '' : 'light');
        localStorage.setItem('theme', isLight ? 'dark' : 'light');
    }

    // Context Menu Logic
    ctxTarget = null;
    openCtx(e, id) {
        e.preventDefault(); e.stopPropagation();
        this.ctxTarget = id;
        const m = $('#ctx-menu');
        m.style.display = 'block'; m.style.left = e.clientX + 'px'; m.style.top = e.clientY + 'px';
        
        // Close on click elsewhere
        const close = () => { m.style.display = 'none'; document.removeEventListener('click', close); };
        setTimeout(() => document.addEventListener('click', close), 50);
    }

    async ctxAction(act) {
        const item = await this.db.get(this.ctxTarget);
        if(!item) return;
        switch(act) {
            case 'play': this.player.playNow(item); break;
            case 'next': this.player.queue.splice(this.player.idx+1, 0, item); this.ui.renderQueue(); this.ui.toast("Added as Next"); break;
            case 'queue': this.player.queue.push(item); this.ui.renderQueue(); this.ui.toast("Added to Queue"); break;
            case 'fav': item.fav = !item.fav; await this.db.update(item); this.ui.renderLibrary(); break;
            case 'delete': await this.db.delete(item.id); this.ui.renderLibrary(); break;
        }
    }
}

// --- PLAYER CONTROLLER ---
class Player {
    constructor(app) {
        this.app = app;
        this.v = $('#video-main');
        this.queue = [];
        this.idx = -1;
        this.filters = {};
        this.loopMode = 0; // 0:off, 1:all, 2:one
        this.shuffle = false;

        this.v.ontimeupdate = () => this.tick();
        this.v.onended = () => this.onEnd();
        this.setupSeek();
        this.setupKeys();
    }

    async load(item) {
        if(!this.app.audio) { this.app.audio = new AudioFX(this.v); this.app.audio.ctx.resume(); }
        
        // Memory Mgmt
        if(this.v.src) URL.revokeObjectURL(this.v.src);
        
        this.v.src = URL.createObjectURL(item.blob);
        $('#np-name').innerText = item.name;
        
        // Dynamic Background Color
        this.extractColor(item);

        try { await this.v.play(); } catch(e) {}
        this.uiUpdate();
    }

    playNow(item) {
        this.queue = [item]; this.idx = 0;
        this.app.ui.renderQueue();
        this.load(item);
        this.app.ui.view('player');
    }

    onEnd() {
        if(this.loopMode === 2) { this.v.currentTime = 0; this.v.play(); return; }
        this.next();
    }

    next() {
        if(this.shuffle) {
            this.idx = Math.floor(Math.random() * this.queue.length);
        } else {
            if(this.idx >= this.queue.length - 1) {
                if(this.loopMode === 1) this.idx = 0; else return;
            } else {
                this.idx++;
            }
        }
        this.load(this.queue[this.idx]);
        this.app.ui.renderQueue();
    }
    
    prev() { if(this.idx > 0) { this.idx--; this.load(this.queue[this.idx]); this.app.ui.renderQueue(); } }

    togglePlay() { this.v.paused ? this.v.play() : this.v.pause(); this.uiUpdate(); }
    toggleMute() { this.v.muted = !this.v.muted; this.app.ui.toast(this.v.muted ? 'Muted' : 'Unmuted'); }
    toggleLoop() { 
        this.loopMode = (this.loopMode + 1) % 3; 
        const modes = ['No Loop', 'Loop All', 'Loop One'];
        this.app.ui.toast(modes[this.loopMode]);
        $('#btn-loop').style.color = this.loopMode > 0 ? 'var(--accent)' : 'inherit';
        $('#btn-loop').innerHTML = this.loopMode === 2 ? '1' : '<svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M12 4V1L8 5l4 4V6c3.31 0 6 2.69 6 6 0 1.01-.25 1.97-.7 2.8l1.46 1.46C19.54 15.03 20 13.57 20 12c0-4.42-3.58-8-8-8zm0 14c-3.31 0-6-2.69-6-6 0-1.01.25-1.97.7-2.8L5.24 7.74C4.46 8.97 4 10.43 4 12c0 4.42 3.58 8 8 8v3l4-4-4-4v3z"/></svg>';
    }
    toggleShuffle() { 
        this.shuffle = !this.shuffle; 
        $('#btn-shuffle').classList.toggle('active');
        this.app.ui.toast(`Shuffle: ${this.shuffle ? 'On' : 'Off'}`);
    }

    setVol(v) { this.v.volume = v/100; }
    setSpeed(v) { this.v.playbackRate = v/100; this.app.ui.toast(`Speed: ${v/100}x`); }
    
    filter(prop, val) { 
        this.filters[prop] = val; 
        this.v.style.filter = Object.entries(this.filters).map(([k,v]) => `${k}(${v})`).join(' '); 
    }

    loadSubs(file) {
        if(!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            const track = document.createElement('track');
            track.kind = "subtitles"; track.label = "English"; track.srclang = "en"; track.default = true;
            // Simple SRT parser to VTT
            const content = "WEBVTT\n\n" + e.target.result.replace(/(\d{2}):(\d{2}):(\d{2}),(\d{3})/g, '$1:$2:$3.$4');
            const blob = new Blob([content], {type: "text/vtt"});
            track.src = URL.createObjectURL(blob);
            this.v.innerHTML = ''; this.v.appendChild(track);
            this.app.ui.toast("Subtitle Loaded");
        };
        reader.readAsText(file);
    }
    subStyle(prop, val) { this.v.style.setProperty(`::cue`, `${prop}:${val}`); } // Not directly supported via JS setProperty on pseudo, would need stylesheet injection.
    
    // Helper to inject css for subtitles
    subStyle(prop, val) {
        let style = $('#dyn-style');
        if(!style) { style = document.createElement('style'); style.id='dyn-style'; document.head.appendChild(style); }
        style.innerHTML = `video::cue { ${prop}: ${val} !important; background: rgba(0,0,0,0.6); color: white; }`;
    }

    extractColor(item) {
        if(item.type.startsWith('audio')) return;
        // Simple heuristic: reset to black, wait for thumb gen logic
        // For real implementation: use canvas from thumb
        if(item.thumb) {
            // Simplified: Not implementing full color-thief here for code length
            // Just setting a random tint for demo effect if thumb exists
            // document.documentElement.style.setProperty('--ambient-color', '#222');
        }
    }

    tick() {
        const d = this.v.duration || 0, c = this.v.currentTime || 0;
        $('#seek-fill').style.width = ((c/d)*100)+'%';
        $('#np-time').innerText = `${formatTime(c)} / ${formatTime(d)}`;
        this.uiUpdate();
    }

    uiUpdate() {
        $('#btn-play').innerHTML = this.v.paused 
            ? '<svg width="32" height="32" viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg>' 
            : '<svg width="32" height="32" viewBox="0 0 24 24" fill="currentColor"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>';
    }

    setupSeek() {
        const bar = $('#seek-bar');
        bar.onclick = e => {
            const rect = bar.getBoundingClientRect();
            const pct = (e.clientX - rect.left) / rect.width;
            if(this.v.duration) this.v.currentTime = this.v.duration * pct;
        };
    }
    
    setupKeys() {
        window.onkeydown = e => {
            if(e.target.tagName === 'INPUT') return;
            switch(e.code) {
                case 'Space': e.preventDefault(); this.togglePlay(); break;
                case 'ArrowRight': this.v.currentTime += 5; break;
                case 'ArrowLeft': this.v.currentTime -= 5; break;
                case 'KeyF': this.toggleFull(); break;
                case 'KeyM': this.toggleMute(); break;
            }
        };
    }
    toggleFull() { !document.fullscreenElement ? document.body.requestFullscreen() : document.exitFullscreen(); }
    togglePiP() { document.pictureInPictureElement ? document.exitPictureInPicture() : this.v.requestPictureInPicture(); }
    clearQueue() { this.queue = []; this.idx = -1; this.app.ui.renderQueue(); this.v.pause(); this.v.src = ''; }
}

// --- UI MANAGER ---
class UI {
    constructor(app) {
        this.app = app;
        this.sortMode = 'date';
        this.filter = '';
        this.currentList = [];
    }

    view(v) {
        if(v === 'library') { $('#library-view').classList.add('active'); $('.nav-btn.active').classList.remove('active'); document.querySelectorAll('.nav-btn')[0].classList.add('active'); }
        else { $('#library-view').classList.remove('active'); }
    }

    tab(t) {
        document.querySelectorAll('.panel-content').forEach(el => el.classList.remove('show'));
        $(`#tab-${t}`).classList.add('show');
        document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));
        event.target.classList.add('active');
    }

    async renderLibrary() {
        const grid = $('#grid-container'); grid.innerHTML = '';
        let items = await this.app.db.getAll();
        
        // Filter
        if(this.filter === 'favorites') items = items.filter(i => i.fav);
        else if(this.filter) items = items.filter(i => i.name.toLowerCase().includes(this.filter.toLowerCase()));

        // Sort
        items.sort((a,b) => {
            if(this.sortMode === 'name') return a.name.localeCompare(b.name);
            if(this.sortMode === 'size') return b.size - a.size;
            return b.date - a.date;
        });

        items.forEach(item => {
            const card = document.createElement('div');
            card.className = `card ${item.fav ? 'favorite' : ''}`;
            card.innerHTML = `
                <div class="card-thumb" data-id="${item.id}" style="${item.thumb ? 'background-image:url('+item.thumb+')' : ''}">
                    ${!item.thumb ? (item.type.startsWith('audio')?'ðŸŽµ':'ðŸŽ¬') : ''}
                    <div class="fav-icon"><svg width="16" height="16" viewBox="0 0 24 24" fill="#fff"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg></div>
                </div>
                <div class="card-info">
                    <div class="card-title">${item.name}</div>
                    <div class="card-meta"><span>${(item.size/1048576).toFixed(1)}MB</span></div>
                </div>
            `;
            // Interactions
            card.onclick = (e) => {
                // Check if clicking heart
                if(e.target.closest('.fav-icon')) return; // handled by ctx usually or specific btn, simplified here to ctx
                this.app.player.playNow(item);
            };
            card.oncontextmenu = (e) => this.app.openCtx(e, item.id);
            
            grid.appendChild(card);
            
            // Lazy Load Thumb
            if(!item.thumb && item.type.startsWith('video')) thumbObserver.observe(card.querySelector('.card-thumb'));
        });
    }

    renderQueue() {
        const list = $('#queue-list'); list.innerHTML = '';
        $('#queue-count').innerText = `${this.app.player.queue.length} items`;
        
        this.app.player.queue.forEach((item, i) => {
            const el = document.createElement('div');
            el.className = `q-item ${i === this.app.player.idx ? 'active' : ''}`;
            el.innerHTML = `<div>${i+1}.</div><div style="flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${item.name}</div>`;
            el.onclick = () => {
                this.app.player.idx = i;
                this.app.player.load(item);
                this.renderQueue();
            };
            // Drag Drop Logic (Simplified)
            el.draggable = true;
            el.ondragstart = e => e.dataTransfer.setData('text/plain', i);
            el.ondragover = e => e.preventDefault();
            el.ondrop = e => {
                e.preventDefault();
                const oldIdx = parseInt(e.dataTransfer.getData('text/plain'));
                const q = this.app.player.queue;
                const moved = q.splice(oldIdx, 1)[0];
                q.splice(i, 0, moved);
                // Adjust current playing index
                if(this.app.player.idx === oldIdx) this.app.player.idx = i;
                this.renderQueue();
            };
            list.appendChild(el);
        });
    }

    filterLibrary(val) { this.filter = val; this.renderLibrary(); }
    sort(mode) { 
        this.sortMode = mode; 
        document.querySelectorAll('.filter-pill').forEach(el => el.classList.remove('active'));
        event.target.classList.add('active');
        this.renderLibrary();
    }
    toast(msg) {
        const t = $('#toast-msg'); t.innerText = msg; t.classList.add('show');
        if(this.tm) clearTimeout(this.tm);
        this.tm = setTimeout(() => t.classList.remove('show'), 2000);
    }
}

// Start
const app = new App();

</script>
</body>
</html>