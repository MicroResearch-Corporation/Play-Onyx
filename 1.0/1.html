<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UltraPlay OS v3.0 | Pro</title>
    <meta name="theme-color" content="#0a0a0a">
    <style>
        /* --- DESIGN TOKENS --- */
        :root {
            --bg-dark: #050505;
            --bg-panel: rgba(18, 18, 18, 0.75);
            --accent: #00f2ff;
            --accent-dim: rgba(0, 242, 255, 0.15);
            --text-main: #ffffff;
            --text-muted: #888888;
            --border: 1px solid rgba(255, 255, 255, 0.08);
            --radius: 16px;
            --font-stack: 'Segoe UI', 'Inter', system-ui, sans-serif;
            --trans: all 0.25s cubic-bezier(0.25, 0.8, 0.25, 1);
            --shadow: 0 8px 32px rgba(0, 0, 0, 0.6);
        }

        /* --- BASE --- */
        * { box-sizing: border-box; outline: none; user-select: none; -webkit-tap-highlight-color: transparent; }
        body {
            margin: 0; background: var(--bg-dark); color: var(--text-main);
            font-family: var(--font-stack); height: 100vh; overflow: hidden;
            background-image: radial-gradient(circle at 10% 20%, #1a1a2e 0%, #000 50%);
        }

        /* --- APP GRID --- */
        #app {
            display: grid;
            grid-template-columns: 260px 1fr 300px;
            grid-template-rows: 1fr 90px;
            height: 100%; width: 100%;
        }

        /* --- SIDEBAR --- */
        .sidebar {
            background: var(--bg-panel); border-right: var(--border);
            padding: 24px; display: flex; flex-direction: column; gap: 8px;
            backdrop-filter: blur(20px); z-index: 10;
        }
        .logo {
            font-size: 1.4rem; font-weight: 800; letter-spacing: -0.5px;
            margin-bottom: 30px; color: var(--text-main); display: flex; align-items: center; gap: 12px;
        }
        .logo svg { fill: var(--accent); filter: drop-shadow(0 0 8px var(--accent)); }
        
        .nav-item {
            padding: 12px 16px; border-radius: 10px; cursor: pointer;
            color: var(--text-muted); font-weight: 500; font-size: 0.95rem;
            display: flex; align-items: center; gap: 14px; transition: var(--trans);
        }
        .nav-item:hover { background: rgba(255,255,255,0.05); color: #fff; }
        .nav-item.active { background: var(--accent-dim); color: var(--accent); }
        .nav-item svg { width: 20px; height: 20px; fill: currentColor; }
        
        .sidebar-divider { height: 1px; background: rgba(255,255,255,0.1); margin: 15px 0; }
        .btn-reset { margin-top: auto; color: #ff4757; }
        .btn-reset:hover { background: rgba(255, 71, 87, 0.1); color: #ff6b81; }

        /* --- MAIN STAGE --- */
        .stage {
            grid-column: 2; position: relative; background: #000;
            overflow: hidden; display: flex; align-items: center; justify-content: center;
        }
        video { width: 100%; height: 100%; object-fit: contain; }
        
        /* Visualizer */
        #visualizer {
            position: absolute; bottom: 0; left: 0; width: 100%; height: 30%;
            pointer-events: none; opacity: 0.6; mix-blend-mode: screen;
            z-index: 5;
        }

        /* Overlay Views (Library) */
        .view-layer {
            position: absolute; inset: 0; background: var(--bg-dark);
            padding: 30px; overflow-y: auto; z-index: 20;
            opacity: 0; pointer-events: none; transform: scale(0.98);
            transition: opacity 0.3s ease, transform 0.3s ease;
        }
        .view-layer.active { opacity: 1; pointer-events: auto; transform: scale(1); }

        /* Media Grid */
        .grid-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
        .drop-target {
            border: 2px dashed rgba(255,255,255,0.1); border-radius: var(--radius);
            padding: 40px; text-align: center; color: var(--text-muted);
            transition: var(--trans); cursor: pointer; margin-bottom: 20px;
        }
        .drop-target:hover, .drop-target.dragover { border-color: var(--accent); background: var(--accent-dim); color: #fff; }

        .media-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 20px; padding-bottom: 100px;
        }
        .card {
            background: rgba(255,255,255,0.03); border-radius: 12px; overflow: hidden;
            cursor: pointer; transition: var(--trans); border: 1px solid transparent;
            position: relative;
        }
        .card:hover { transform: translateY(-4px); background: rgba(255,255,255,0.08); border-color: rgba(255,255,255,0.1); box-shadow: 0 10px 20px rgba(0,0,0,0.4); }
        .card-thumb {
            height: 100px; background: #000; position: relative;
            background-size: cover; background-position: center;
            display: flex; align-items: center; justify-content: center;
        }
        .card-badge {
            position: absolute; top: 6px; right: 6px; background: rgba(0,0,0,0.8);
            padding: 2px 6px; border-radius: 4px; font-size: 0.65rem; font-weight: bold;
        }
        .card-info { padding: 12px; }
        .card-title { font-size: 0.85rem; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .card-meta { font-size: 0.75rem; color: var(--text-muted); margin-top: 4px; display: flex; justify-content: space-between; }
        
        .btn-delete-item {
            position: absolute; top: 5px; left: 5px; width: 24px; height: 24px;
            background: rgba(255,0,0,0.7); border-radius: 50%; display: none;
            align-items: center; justify-content: center; z-index: 5;
        }
        .card:hover .btn-delete-item { display: flex; }

        /* --- RIGHT PANEL --- */
        .panel {
            grid-column: 3; background: var(--bg-panel); border-left: var(--border);
            display: flex; flex-direction: column; backdrop-filter: blur(20px);
        }
        .tabs { display: flex; border-bottom: var(--border); }
        .tab {
            flex: 1; padding: 16px; text-align: center; font-size: 0.85rem;
            color: var(--text-muted); cursor: pointer; position: relative;
        }
        .tab.active { color: #fff; }
        .tab.active::after { content:''; position: absolute; bottom: 0; left: 0; width: 100%; height: 2px; background: var(--accent); box-shadow: 0 0 10px var(--accent); }
        
        .panel-body { flex: 1; overflow-y: auto; padding: 0; }
        .queue-item {
            padding: 12px 20px; border-bottom: 1px solid rgba(255,255,255,0.03);
            font-size: 0.85rem; cursor: pointer; transition: 0.2s; display: flex; justify-content: space-between;
        }
        .queue-item:hover { background: rgba(255,255,255,0.05); }
        .queue-item.playing { border-left: 3px solid var(--accent); background: linear-gradient(90deg, var(--accent-dim), transparent); color: var(--accent); }

        /* Controls UI */
        .setting-group { padding: 20px; }
        .setting-label { font-size: 0.8rem; color: var(--text-muted); margin-bottom: 10px; display: flex; justify-content: space-between; }
        
        /* Custom Range Slider */
        input[type=range] {
            appearance: none; width: 100%; background: transparent; margin: 10px 0;
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%; height: 4px; background: rgba(255,255,255,0.1); border-radius: 2px;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none; height: 14px; width: 14px; border-radius: 50%;
            background: #fff; margin-top: -5px; box-shadow: 0 0 10px rgba(0,0,0,0.5);
            transition: 0.2s;
        }
        input[type=range]:hover::-webkit-slider-thumb { background: var(--accent); transform: scale(1.2); }

        /* --- PLAYER BAR --- */
        .player-bar {
            grid-column: 1 / -1; background: rgba(10,10,10,0.9); border-top: var(--border);
            backdrop-filter: blur(25px); padding: 0 24px; display: flex; flex-direction: column;
            justify-content: center; z-index: 100; position: relative;
        }
        
        .progress-area {
            position: absolute; top: -8px; left: 0; width: 100%; height: 16px;
            cursor: pointer; z-index: 101; display: flex; align-items: center;
        }
        .progress-bg { width: 100%; height: 3px; background: rgba(255,255,255,0.1); transition: height 0.2s; }
        .progress-fill { height: 100%; background: var(--accent); width: 0%; box-shadow: 0 0 10px var(--accent); position: relative;}
        .progress-area:hover .progress-bg { height: 6px; }
        .progress-thumb { 
            position: absolute; right: -6px; top: -3px; width: 12px; height: 12px; 
            background: #fff; border-radius: 50%; opacity: 0; transition: opacity 0.2s; 
        }
        .progress-area:hover .progress-thumb { opacity: 1; }

        .controls { display: flex; align-items: center; justify-content: space-between; margin-top: 5px;}
        .ctrl-group { display: flex; align-items: center; gap: 16px; }
        
        .btn-icon {
            background: none; border: none; color: #ccc; cursor: pointer;
            width: 36px; height: 36px; border-radius: 50%; display: flex;
            align-items: center; justify-content: center; transition: 0.2s;
        }
        .btn-icon:hover { background: rgba(255,255,255,0.1); color: #fff; }
        .btn-play {
            width: 48px; height: 48px; background: #fff; color: #000;
            box-shadow: 0 0 20px rgba(255,255,255,0.3);
        }
        .btn-play:hover { transform: scale(1.05); background: var(--accent); box-shadow: 0 0 20px var(--accent); }

        .time-display { font-family: monospace; color: var(--text-muted); font-size: 0.85rem; width: 110px; text-align: center; }

        /* --- UTILS --- */
        .hidden { display: none !important; }
        .toast {
            position: fixed; bottom: 110px; left: 50%; transform: translateX(-50%) translateY(20px);
            background: rgba(20, 20, 20, 0.9); border: 1px solid rgba(255,255,255,0.2);
            padding: 12px 24px; border-radius: 30px; color: #fff; pointer-events: none;
            opacity: 0; transition: 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); z-index: 1000;
            font-weight: 500; box-shadow: 0 10px 30px rgba(0,0,0,0.5); display: flex; align-items: center; gap: 10px;
        }
        .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

        /* Responsive */
        @media(max-width: 900px) {
            #app { grid-template-columns: 1fr; grid-template-rows: 1fr 90px; }
            .sidebar, .panel { position: fixed; inset: 0; z-index: 200; background: #111; transform: translateX(-100%); transition: transform 0.3s; width: 85%; }
            .sidebar.open, .panel.open { transform: translateX(0); }
            .panel { right: 0; left: auto; transform: translateX(100%); width: 300px; border-left: 1px solid #333; }
            .mobile-toggle { display: block !important; }
        }
        .mobile-toggle { display: none; }
    </style>
</head>
<body>

<div id="app">
    <!-- SIDEBAR -->
    <aside class="sidebar" id="sidebar">
        <div class="logo">
            <svg viewBox="0 0 24 24" width="28" height="28"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 14.5v-9l6 4.5-6 4.5z"/></svg>
            UltraPlay OS
        </div>

        <div class="nav-item active" onclick="ui.navigate('library')">
            <svg viewBox="0 0 24 24"><path d="M4 6H2v14c0 1.1.9 2 2 2h14v-2H4V6zm16-4H8c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-1 9h-4v4h-2v-4H9V9h4V5h2v4h4v2z"/></svg>
            Library
        </div>
        <div class="nav-item" onclick="ui.navigate('player')">
            <svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
            Now Playing
        </div>
        
        <div class="sidebar-divider"></div>
        <div style="font-size:0.75rem; color:#666; font-weight:700; padding:0 10px; margin-bottom:10px;">ACTIONS</div>
        
        <div class="nav-item" onclick="document.getElementById('file-input').click()">
            <svg viewBox="0 0 24 24"><path d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zm2 16H8v-2h8v2zm0-4H8v-2h8v2zm-3-5V3.5L18.5 9H13z"/></svg>
            Import Files
        </div>
        <div class="nav-item" onclick="document.getElementById('folder-input').click()">
            <svg viewBox="0 0 24 24"><path d="M20 6h-8l-2-2H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2zm0 12H4V8h16v10z"/></svg>
            Import Folder
        </div>

        <div class="nav-item btn-reset" onclick="app.reset()">
            <svg viewBox="0 0 24 24"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>
            Reset Data
        </div>
    </aside>

    <!-- MAIN STAGE -->
    <main class="stage" onclick="ui.toggleBars()">
        <video id="video-element" playsinline crossorigin="anonymous"></video>
        <canvas id="visualizer"></canvas>

        <!-- Library Overlay -->
        <div id="view-library" class="view-layer active">
            <div class="grid-header">
                <h1 style="margin:0; font-size:2rem;">Media Library</h1>
                <span id="lib-count" style="color:#666; font-weight:600;">0 items</span>
            </div>
            
            <div id="drop-target" class="drop-target">
                <div style="font-size: 2rem; margin-bottom: 10px;">ðŸ“‚</div>
                <div>Drag & Drop Media Files or Folders Here</div>
                <div style="font-size:0.8rem; margin-top:5px; color:#666;">Supports MP4, MKV, MP3, WEBM</div>
            </div>

            <div class="media-grid" id="media-grid"></div>
        </div>
    </main>

    <!-- RIGHT PANEL -->
    <aside class="panel" id="right-panel">
        <div class="tabs">
            <div class="tab active" onclick="ui.switchTab('queue', this)">Queue</div>
            <div class="tab" onclick="ui.switchTab('audio', this)">Audio/Video</div>
        </div>

        <div id="tab-queue" class="panel-body">
            <div id="queue-list"></div>
            <div style="padding:20px; text-align:center; color:#555; font-size:0.9rem;" id="queue-empty-msg">Queue is empty</div>
        </div>

        <div id="tab-audio" class="panel-body hidden">
            <div class="setting-group">
                <div class="setting-label"><span>Master Volume</span> <span id="val-vol">100%</span></div>
                <input type="range" min="0" max="1" step="0.05" value="1" oninput="player.volume(this.value)">

                <div class="setting-label"><span>Playback Speed</span> <span id="val-spd">1.0x</span></div>
                <input type="range" min="0.5" max="2.5" step="0.25" value="1" oninput="player.speed(this.value)">
                
                <div style="margin-top:20px; font-weight:700; color:var(--accent); font-size:0.8rem; margin-bottom:10px;">3-BAND EQ</div>
                <div class="setting-label">Bass</div>
                <input type="range" min="-12" max="12" value="0" oninput="audio.eq('bass', this.value)">
                <div class="setting-label">Mids</div>
                <input type="range" min="-12" max="12" value="0" oninput="audio.eq('mid', this.value)">
                <div class="setting-label">Treble</div>
                <input type="range" min="-12" max="12" value="0" oninput="audio.eq('treble', this.value)">

                <div style="margin-top:20px; font-weight:700; color:var(--accent); font-size:0.8rem; margin-bottom:10px;">VIDEO FILTERS</div>
                <div class="setting-label">Brightness</div>
                <input type="range" min="0.5" max="1.5" step="0.05" value="1" oninput="player.filter('brightness', this.value)">
                <div class="setting-label">Contrast</div>
                <input type="range" min="0.5" max="1.5" step="0.05" value="1" oninput="player.filter('contrast', this.value)">
                
                <button class="nav-item" style="width:100%; justify-content:center; background:rgba(255,255,255,0.05); margin-top:20px;" onclick="document.getElementById('sub-input').click()">
                    Load Subtitles (.srt/.vtt)
                </button>
            </div>
        </div>
    </aside>

    <!-- PLAYER BAR -->
    <div class="player-bar">
        <div class="progress-area" id="seek-bar">
            <div class="progress-bg">
                <div class="progress-fill" id="seek-fill">
                    <div class="progress-thumb"></div>
                </div>
            </div>
        </div>

        <div class="controls">
            <div class="ctrl-group">
                <button class="btn-icon" onclick="player.prev()"><svg width="24" height="24" fill="currentColor" viewBox="0 0 24 24"><path d="M6 6h2v12H6zm3.5 6l8.5 6V6z"/></svg></button>
                <button class="btn-icon btn-play" id="btn-play" onclick="player.toggle()"><svg width="32" height="32" fill="currentColor" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg></button>
                <button class="btn-icon" onclick="player.next()"><svg width="24" height="24" fill="currentColor" viewBox="0 0 24 24"><path d="M6 18l8.5-6L6 6v12zM16 6v12h2V6h-2z"/></svg></button>
                <div class="time-display" id="time-display">00:00 / 00:00</div>
            </div>
            
            <div class="ctrl-group">
                <div style="font-size:0.85rem; font-weight:bold; color:var(--accent);" id="file-title-bar"></div>
            </div>

            <div class="ctrl-group">
                <button class="btn-icon" title="Picture in Picture" onclick="player.pip()"><svg width="20" height="20" fill="currentColor" viewBox="0 0 24 24"><path d="M19 11h-8v6h8v-6zm4 8V4.98C23 3.88 22.1 3 21 3H3c-1.1 0-2 .88-2 1.98V19c0 1.1.9 2 2 2h18c1.1 0 2-.9 2-2zm-2 .02H3V4.97h18v14.05z"/></svg></button>
                <button class="btn-icon" title="Fullscreen" onclick="player.fullscreen()"><svg width="24" height="24" fill="currentColor" viewBox="0 0 24 24"><path d="M7 14H5v5h5v-2H7v-3zm-2-4h2V7h3V5H5v5zm12 7h-3v2h5v-5h-2v3zM14 5v2h3v3h2V5h-5z"/></svg></button>
                <button class="btn-icon mobile-toggle" onclick="document.getElementById('right-panel').classList.toggle('open')"><svg width="24" height="24" fill="currentColor" viewBox="0 0 24 24"><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg></button>
            </div>
        </div>
    </div>
</div>

<div id="toast" class="toast">
    <svg width="20" height="20" fill="#4cd137" viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>
    <span id="toast-msg">Notification</span>
</div>

<!-- Hidden Inputs -->
<input type="file" id="file-input" multiple accept="video/*,audio/*" class="hidden">
<input type="file" id="folder-input" webkitdirectory directory multiple class="hidden">
<input type="file" id="sub-input" accept=".srt,.vtt" class="hidden">

<script>
/**
 * ULTRA PLAY OS v3.0 CORE
 */

// --- UTILITIES ---
const $ = (s) => document.querySelector(s);
const $$ = (s) => document.querySelectorAll(s);
const Utils = {
    uuid: () => Math.random().toString(36).substr(2, 9),
    fmtTime: (s) => {
        if (!s || isNaN(s)) return "00:00";
        let m = Math.floor(s / 60), sec = Math.floor(s % 60);
        let h = Math.floor(m / 60); m = m % 60;
        return (h>0 ? h+':' : '') + (m<10?'0'+m:m) + ':' + (sec<10?'0'+sec:sec);
    },
    srtToVtt: (srt) => "WEBVTT\n\n" + srt.replace(/(\d{2}):(\d{2}):(\d{2}),(\d{3})/g, '$1:$2:$3.$4')
};

// --- DATABASE (IndexedDB) ---
class Database {
    constructor() {
        this.dbName = 'UltraPlayDB_v3';
        this.conn = new Promise((resolve, reject) => {
            const req = indexedDB.open(this.dbName, 1);
            req.onupgradeneeded = e => {
                const db = e.target.result;
                if (!db.objectStoreNames.contains('library')) db.createObjectStore('library', { keyPath: 'id' });
            };
            req.onsuccess = e => resolve(e.target.result);
            req.onerror = e => reject(e);
        });
    }
    async add(files) {
        const db = await this.conn;
        const tx = db.transaction('library', 'readwrite');
        const store = tx.objectStore('library');
        let count = 0;
        for (const file of files) {
            if(!file.type.match(/^(video|audio)/)) continue;
            store.add({
                id: Utils.uuid(), name: file.name, type: file.type,
                blob: file, size: file.size, date: Date.now(), thumb: null
            });
            count++;
        }
        return new Promise(r => tx.oncomplete = () => r(count));
    }
    async getAll() {
        const db = await this.conn;
        return new Promise(r => db.transaction('library').objectStore('library').getAll().onsuccess = e => r(e.target.result));
    }
    async update(data) {
        const db = await this.conn;
        const tx = db.transaction('library', 'readwrite');
        tx.objectStore('library').put(data);
    }
    async delete(id) {
        const db = await this.conn;
        const tx = db.transaction('library', 'readwrite');
        tx.objectStore('library').delete(id);
        return new Promise(r => tx.oncomplete = r);
    }
    async wipe() {
        indexedDB.deleteDatabase(this.dbName);
        location.reload();
    }
}

// --- THUMBNAIL ENGINE (Non-Blocking) ---
class ThumbEngine {
    constructor() {
        this.queue = [];
        this.active = false;
        this.canvas = document.createElement('canvas');
        this.canvas.width = 160; this.canvas.height = 90;
        this.ctx = this.canvas.getContext('2d');
    }
    add(item) {
        if(item.type.startsWith('audio')) return;
        this.queue.push(item);
        this.process();
    }
    async process() {
        if (this.active || !this.queue.length) return;
        this.active = true;
        
        const item = this.queue.shift();
        try {
            const vid = document.createElement('video');
            vid.src = URL.createObjectURL(item.blob);
            vid.currentTime = 5; // Snap at 5s
            vid.muted = true;
            
            await new Promise((resolve, reject) => {
                vid.onloadeddata = () => {
                    vid.onseeked = () => {
                        this.ctx.drawImage(vid, 0, 0, 160, 90);
                        item.thumb = this.canvas.toDataURL('image/jpeg', 0.6);
                        db.update(item);
                        ui.updateThumb(item.id, item.thumb);
                        URL.revokeObjectURL(vid.src);
                        resolve();
                    };
                    vid.currentTime = Math.min(vid.duration / 2, 10);
                };
                vid.onerror = reject;
            });
        } catch(e) { console.warn("Thumb error", e); }
        
        this.active = false;
        setTimeout(() => this.process(), 50); // Small delay to unblock UI
    }
}

// --- AUDIO VISUALIZER ---
class AudioVis {
    constructor(video) {
        this.v = video;
        this.ctx = new (window.AudioContext || window.webkitAudioContext)();
        this.src = this.ctx.createMediaElementSource(this.v);
        
        // EQ
        this.bands = {
            bass: this.createFilter('lowshelf', 100),
            mid: this.createFilter('peaking', 1000),
            treble: this.createFilter('highshelf', 3000)
        };
        
        this.analyser = this.ctx.createAnalyser();
        this.analyser.fftSize = 256;
        
        // Graph: Src -> Bass -> Mid -> Treble -> Analyser -> Dest
        this.src.connect(this.bands.bass);
        this.bands.bass.connect(this.bands.mid);
        this.bands.mid.connect(this.bands.treble);
        this.bands.treble.connect(this.analyser);
        this.analyser.connect(this.ctx.destination);
        
        this.render();
    }
    createFilter(type, freq) {
        const f = this.ctx.createBiquadFilter();
        f.type = type; f.frequency.value = freq;
        return f;
    }
    eq(band, val) { if(this.bands[band]) this.bands[band].gain.value = val; }
    
    render() {
        const cvs = $('#visualizer');
        const ctx = cvs.getContext('2d');
        const buffer = this.analyser.frequencyBinCount;
        const data = new Uint8Array(buffer);
        
        const draw = () => {
            requestAnimationFrame(draw);
            if(this.v.paused) return;
            
            // Auto resize
            if(cvs.width !== cvs.offsetWidth) { cvs.width = cvs.offsetWidth; cvs.height = cvs.offsetHeight; }
            
            this.analyser.getByteFrequencyData(data);
            ctx.clearRect(0,0,cvs.width,cvs.height);
            
            const w = cvs.width; const h = cvs.height;
            const barW = (w / buffer) * 2;
            
            ctx.fillStyle = getComputedStyle(document.body).getPropertyValue('--accent');
            
            for(let i=0; i<buffer; i++) {
                const barH = (data[i] / 255) * h;
                const x = i * barW;
                // Mirrored visualizer
                ctx.fillRect(w/2 + x, h - barH, barW - 1, barH);
                ctx.fillRect(w/2 - x, h - barH, barW - 1, barH);
            }
        };
        draw();
    }
    resume() { if(this.ctx.state === 'suspended') this.ctx.resume(); }
}

// --- PLAYER CONTROLLER ---
class Player {
    constructor() {
        this.v = $('#video-element');
        this.queue = [];
        this.index = 0;
        this.filters = { brightness: 1, contrast: 1 };
        
        // Save/Load Settings
        const settings = JSON.parse(localStorage.getItem('ultraplay_cfg') || '{}');
        this.v.volume = settings.vol !== undefined ? settings.vol : 1;
        this.v.playbackRate = settings.speed || 1;
        $('#val-vol').innerText = Math.round(this.v.volume*100)+'%';
        $('#val-spd').innerText = this.v.playbackRate+'x';
        
        // Events
        this.v.ontimeupdate = () => this.tick();
        this.v.onended = () => this.next();
        this.v.onvolumechange = () => this.save();
        this.v.onratechange = () => this.save();
    }
    
    load(media) {
        this.v.src = URL.createObjectURL(media.blob);
        this.v.play().catch(()=>{});
        this.saveHistory(media);
        
        $('#file-title-bar').innerText = media.name;
        $('#visualizer').style.display = media.type.startsWith('audio') ? 'block' : 'none';
        
        if(audio) audio.resume();
        ui.highlight(this.index);
        ui.navigate('player');
    }

    playList(list, idx) {
        this.queue = list;
        this.index = idx;
        ui.renderQueue(list);
        this.load(this.queue[this.index]);
    }
    
    toggle() { 
        this.v.paused ? this.v.play() : this.v.pause();
        this.updateBtn();
    }
    
    next() { if(this.index < this.queue.length-1) { this.index++; this.load(this.queue[this.index]); }}
    prev() { if(this.index > 0) { this.index--; this.load(this.queue[this.index]); }}
    
    seek(pct) { if(this.v.duration) this.v.currentTime = this.v.duration * pct; }
    volume(v) { this.v.volume = v; $('#val-vol').innerText = Math.round(v*100)+'%'; }
    speed(s) { this.v.playbackRate = s; $('#val-spd').innerText = s+'x'; }
    
    filter(name, val) {
        this.filters[name] = val;
        this.v.style.filter = `brightness(${this.filters.brightness}) contrast(${this.filters.contrast})`;
    }
    
    pip() { document.pictureInPictureElement ? document.exitPictureInPicture() : this.v.requestPictureInPicture(); }
    fullscreen() { document.fullscreenElement ? document.exitFullscreen() : document.body.requestFullscreen(); }
    
    tick() {
        const pct = (this.v.currentTime / this.v.duration) * 100 || 0;
        $('#seek-fill').style.width = pct + '%';
        $('#time-display').innerText = `${Utils.fmtTime(this.v.currentTime)} / ${Utils.fmtTime(this.v.duration)}`;
        this.updateBtn();
    }
    
    updateBtn() {
        $('#btn-play').innerHTML = this.v.paused 
        ? '<svg width="32" height="32" fill="currentColor" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>'
        : '<svg width="32" height="32" fill="currentColor" viewBox="0 0 24 24"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>';
    }

    save() {
        localStorage.setItem('ultraplay_cfg', JSON.stringify({
            vol: this.v.volume, speed: this.v.playbackRate
        }));
    }
    saveHistory(media) {
        // Could save "last played" here
    }
}

// --- UI MANAGER ---
class UI {
    constructor() {
        this.initDrag();
        this.initSeek();
        this.initKeys();
    }

    navigate(view) {
        $$('.view-layer').forEach(e => e.classList.remove('active'));
        $$('.sidebar .nav-item').forEach(e => e.classList.remove('active'));
        
        if(view === 'library') {
            $('#view-library').classList.add('active');
            $$('.sidebar .nav-item')[0].classList.add('active');
        } else {
            $$('.sidebar .nav-item')[1].classList.add('active');
        }
        // Mobile close sidebar
        $('#sidebar').classList.remove('open');
    }

    switchTab(id, el) {
        $$('.panel-body').forEach(e => e.classList.add('hidden'));
        $$('.tab').forEach(e => e.classList.remove('active'));
        $(`#tab-${id}`).classList.remove('hidden');
        el.classList.add('active');
    }

    async renderLib() {
        const items = await db.getAll();
        const grid = $('#media-grid');
        grid.innerHTML = '';
        $('#lib-count').innerText = `${items.length} items`;
        
        const frag = document.createDocumentFragment();
        items.forEach(item => {
            const el = document.createElement('div');
            el.className = 'card';
            el.id = `c-${item.id}`;
            const typeIcon = item.type.startsWith('audio') ? 'ðŸŽµ' : 'ðŸŽ¬';
            el.innerHTML = `
                <div class="card-thumb" style="background-image:url('${item.thumb||''}')">
                    ${!item.thumb ? typeIcon : ''}
                    <div class="card-badge">${item.type.split('/')[1].toUpperCase()}</div>
                    <div class="btn-delete-item" onclick="app.delete('${item.id}', event)">Ã—</div>
                </div>
                <div class="card-info">
                    <div class="card-title" title="${item.name}">${item.name}</div>
                    <div class="card-meta"><span>${(item.size/1024/1024).toFixed(1)}MB</span></div>
                </div>
            `;
            el.onclick = (e) => {
               if(e.target.className !== 'btn-delete-item') player.playList(items, items.indexOf(item)); 
            };
            frag.appendChild(el);
            if(!item.thumb && item.type.startsWith('video')) thumbs.add(item);
        });
        grid.appendChild(frag);
    }

    renderQueue(list) {
        const q = $('#queue-list');
        q.innerHTML = '';
        $('#queue-empty-msg').style.display = list.length ? 'none' : 'block';
        list.forEach((item, i) => {
            const div = document.createElement('div');
            div.className = 'queue-item';
            div.id = `q-${i}`;
            div.innerHTML = `<span>${i+1}. ${item.name}</span>`;
            div.onclick = () => { player.index = i; player.load(item); };
            q.appendChild(div);
        });
    }

    highlight(idx) {
        $$('.queue-item').forEach(e => e.classList.remove('playing'));
        const el = $(`#q-${idx}`);
        if(el) { el.classList.add('playing'); el.scrollIntoView({block:'center', behavior:'smooth'}); }
    }
    
    updateThumb(id, url) {
        const el = $(`#c-${id} .card-thumb`);
        if(el) { el.style.backgroundImage = `url('${url}')`; el.innerText = ''; }
    }

    toast(msg) {
        const t = $('#toast');
        $('#toast-msg').innerText = msg;
        t.classList.add('show');
        setTimeout(() => t.classList.remove('show'), 2500);
    }

    toggleBars() {
        /* Simple immersive mode toggle */
        $('.player-bar').style.transform = $('.player-bar').style.transform ? '' : 'translateY(100%)';
        // Logic could be expanded for full UI toggle
    }

    initDrag() {
        const t = $('#drop-target');
        const handle = async (e) => {
            e.preventDefault(); e.stopPropagation();
            t.classList.toggle('dragover', e.type === 'dragover');
            if(e.type === 'drop') {
                const files = [...e.dataTransfer.files];
                if(files.length) {
                    this.toast(`Processing ${files.length} files...`);
                    await db.add(files);
                    this.renderLib();
                }
            }
        };
        ['dragenter','dragover','dragleave','drop'].forEach(ev => t.addEventListener(ev, handle));

        $('#file-input').onchange = (e) => this.handleFiles(e.target.files);
        $('#folder-input').onchange = (e) => this.handleFiles(e.target.files);
    }
    
    async handleFiles(files) {
        if(!files.length) return;
        this.toast("Importing...");
        await db.add(files);
        this.renderLib();
    }

    initSeek() {
        const bar = $('#seek-bar');
        bar.onclick = e => {
            const r = bar.getBoundingClientRect();
            player.seek((e.clientX - r.left) / r.width);
        };
    }
    
    initKeys() {
        document.addEventListener('keydown', e => {
            if(e.target.tagName === 'INPUT') return;
            switch(e.code) {
                case 'Space': e.preventDefault(); player.toggle(); break;
                case 'ArrowRight': player.v.currentTime += 5; break;
                case 'ArrowLeft': player.v.currentTime -= 5; break;
                case 'ArrowUp': player.v.volume = Math.min(1, player.v.volume + 0.1); break;
                case 'ArrowDown': player.v.volume = Math.max(0, player.v.volume - 0.1); break;
                case 'KeyF': player.fullscreen(); break;
                case 'KeyM': player.v.muted = !player.v.muted; break;
            }
        });
        
        // Subtitles
        $('#sub-input').onchange = e => {
            const f = e.target.files[0];
            const r = new FileReader();
            r.onload = v => {
                let txt = v.target.result;
                if(f.name.endsWith('.srt')) txt = Utils.srtToVtt(txt);
                const blob = new Blob([txt], {type: 'text/vtt'});
                const url = URL.createObjectURL(blob);
                const t = document.createElement('track');
                t.kind = 'subtitles'; t.label = 'En'; t.src = url; t.default = true;
                player.v.innerHTML = ''; player.v.appendChild(t);
                this.toast("Subtitles Loaded");
            };
            r.readAsText(f);
        };
    }
}

// --- BOOTSTRAP ---
const db = new Database();
const thumbs = new ThumbEngine();
const ui = new UI();
const player = new Player();
let audio;

const app = {
    reset: async () => { if(confirm("Clear library?")) await db.wipe(); },
    delete: async (id, e) => {
        e.stopPropagation();
        if(confirm("Remove this item?")) {
            await db.delete(id);
            ui.renderLib();
        }
    }
};

(async () => {
    await ui.renderLib();
    // Init audio on first interaction
    document.body.addEventListener('click', () => {
        if(!audio) audio = new AudioVis($('#video-element'));
    }, {once:true});
})();
</script>
</body>
</html>