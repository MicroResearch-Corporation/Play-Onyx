<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UltraPlay OS v2.1 - Pro</title>
    <meta name="theme-color" content="#050505">
    <style>
        /* --- CORE DESIGN SYSTEM v2.1 --- */
        :root {
            --bg-color: #050505;
            --sidebar-bg: rgba(12, 12, 12, 0.85);
            --surface-color: rgba(35, 35, 35, 0.6);
            --surface-hover: rgba(255, 255, 255, 0.08);
            --accent-color: #00f2ff;
            --accent-dim: rgba(0, 242, 255, 0.15);
            --accent-glow: 0 0 20px rgba(0, 242, 255, 0.3);
            --text-primary: #ffffff;
            --text-secondary: #a0a0a0;
            --glass-border: 1px solid rgba(255, 255, 255, 0.08);
            --radius-sm: 8px;
            --radius-md: 14px;
            --radius-full: 999px;
            --font-main: 'Segoe UI', 'Inter', system-ui, sans-serif;
        }

        /* --- BASE --- */
        * { box-sizing: border-box; outline: none; user-select: none; -webkit-tap-highlight-color: transparent; }
        body { 
            margin: 0; font-family: var(--font-main); background: #000;
            background-image: radial-gradient(circle at 50% 120%, #1a1a1a 0%, #000 60%);
            color: var(--text-primary); height: 100vh; overflow: hidden; 
        }

        /* SCROLLBARS */
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #444; border-radius: 2px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--accent-color); }

        /* --- LAYOUT --- */
        #app {
            display: grid;
            grid-template-columns: 260px 1fr 300px;
            grid-template-rows: 1fr 90px;
            height: 100%; width: 100%;
        }

        /* --- SIDEBAR --- */
        .sidebar {
            background: var(--sidebar-bg);
            border-right: var(--glass-border);
            padding: 24px 16px; display: flex; flex-direction: column; gap: 8px;
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            z-index: 50;
        }
        .app-logo {
            font-size: 1.4rem; font-weight: 700; letter-spacing: -0.5px;
            margin-bottom: 25px; color: #fff; padding-left: 12px;
            display: flex; align-items: center; gap: 12px;
        }
        .app-logo svg { filter: drop-shadow(0 0 8px var(--accent-color)); }
        
        .search-container { margin-bottom: 15px; padding: 0 5px; }
        .search-input {
            width: 100%; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1);
            color: white; padding: 10px 12px; border-radius: var(--radius-sm); font-family: inherit;
            transition: 0.3s;
        }
        .search-input:focus { border-color: var(--accent-color); background: rgba(0,0,0,0.3); }

        .nav-btn {
            padding: 12px 16px; border-radius: var(--radius-md); cursor: pointer;
            color: var(--text-secondary); transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex; align-items: center; gap: 14px; font-size: 0.95rem; font-weight: 500;
        }
        .nav-btn:hover { background: var(--surface-hover); color: white; transform: translateX(4px); }
        .nav-btn.active { 
            background: var(--accent-dim); color: var(--accent-color); 
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        .nav-icon { width: 22px; height: 22px; fill: currentColor; }

        .sidebar-divider { height: 1px; background: rgba(255,255,255,0.05); margin: 15px 10px; }
        .playlist-header {
            padding: 0 16px; font-size: 0.7rem; color: #555; font-weight: 700; letter-spacing: 1.5px;
            display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;
        }
        .add-pl-btn { cursor: pointer; padding: 5px; border-radius: 4px; }
        .add-pl-btn:hover { background: rgba(255,255,255,0.1); color: white; }

        /* --- STAGE --- */
        .stage {
            grid-column: 2; grid-row: 1; position: relative;
            background: #000; overflow: hidden; display: flex; align-items: center; justify-content: center;
        }
        #video-element { width: 100%; height: 100%; object-fit: contain; z-index: 1; }
        
        /* Visualizer */
        #visualizer-canvas { 
            position: absolute; bottom: 0; left: 0; width: 100%; height: 120px; 
            z-index: 2; pointer-events: none; opacity: 0.6; mix-blend-mode: screen;
            display: none; transition: opacity 0.5s;
        }
        
        /* Views */
        .view-overlay {
            position: absolute; inset: 0; background: var(--bg-color); z-index: 10;
            padding: 30px 40px; overflow-y: auto; display: none;
            animation: fadeIn 0.4s cubic-bezier(0.2, 0.8, 0.2, 1);
        }
        .view-overlay.active { display: block; }

        .media-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 25px; padding-bottom: 60px;
        }
        .media-card {
            background: rgba(255,255,255,0.03); border-radius: var(--radius-md);
            overflow: hidden; cursor: pointer; transition: all 0.3s;
            position: relative; border: 1px solid transparent;
        }
        .media-card:hover { 
            transform: translateY(-6px) scale(1.02); 
            background: rgba(255,255,255,0.06);
            border-color: rgba(255,255,255,0.1);
            box-shadow: 0 15px 30px rgba(0,0,0,0.5);
        }
        .thumb-box {
            height: 110px; background: #151515; position: relative;
            background-size: cover; background-position: center;
            display: flex; align-items: center; justify-content: center;
            font-size: 2rem; color: #333;
        }
        .media-card:hover .play-overlay { opacity: 1; }
        .play-overlay {
            position: absolute; inset: 0; background: rgba(0,0,0,0.5);
            display: flex; align-items: center; justify-content: center;
            opacity: 0; transition: opacity 0.2s;
        }
        .info-box { padding: 14px; }
        .file-name { font-size: 0.9rem; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: #eee; }
        .file-meta { font-size: 0.75rem; color: #666; margin-top: 6px; display: flex; justify-content: space-between; }

        /* --- RIGHT PANEL --- */
        .right-panel {
            grid-column: 3; grid-row: 1;
            background: var(--sidebar-bg);
            border-left: var(--glass-border);
            display: flex; flex-direction: column;
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            z-index: 50;
        }
        .panel-tabs { display: flex; background: rgba(0,0,0,0.2); padding: 5px; margin: 10px; border-radius: var(--radius-sm); }
        .panel-tab {
            flex: 1; padding: 10px; text-align: center; cursor: pointer;
            font-size: 0.8rem; color: var(--text-secondary); border-radius: var(--radius-sm);
            transition: 0.2s; font-weight: 600;
        }
        .panel-tab.active { background: rgba(255,255,255,0.1); color: #fff; }
        
        .queue-item {
            padding: 12px 20px; display: flex; align-items: center; gap: 12px; cursor: pointer;
            border-bottom: 1px solid rgba(255,255,255,0.02); transition: background 0.2s;
        }
        .queue-item:hover { background: var(--surface-hover); }
        .queue-item.playing { background: var(--accent-dim); border-left: 3px solid var(--accent-color); }
        .playing-indicator {
            width: 8px; height: 8px; background: var(--accent-color); border-radius: 50%;
            box-shadow: 0 0 10px var(--accent-color);
        }

        /* Controls sliders */
        .control-group { padding: 20px; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .control-header { color: var(--accent-color); font-size: 0.75rem; font-weight: 700; letter-spacing: 1px; margin-bottom: 15px; }
        .slider-row { display: flex; align-items: center; gap: 10px; margin-bottom: 12px; }
        .slider-label { width: 70px; font-size: 0.8rem; color: #aaa; }
        input[type="range"] {
            flex: 1; -webkit-appearance: none; height: 4px; background: #333; border-radius: 2px;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none; width: 12px; height: 12px;
            background: #fff; border-radius: 50%; cursor: pointer;
            transition: 0.2s;
        }
        input[type="range"]:hover::-webkit-slider-thumb { background: var(--accent-color); transform: scale(1.2); }

        /* --- PLAYER BAR --- */
        .player-bar {
            grid-column: 1 / -1; grid-row: 2;
            background: rgba(10, 10, 10, 0.9);
            border-top: var(--glass-border);
            display: flex; flex-direction: column; justify-content: center;
            padding: 0 30px; z-index: 100;
            backdrop-filter: blur(25px); -webkit-backdrop-filter: blur(25px);
        }
        .seek-container {
            width: 100%; height: 12px; display: flex; align-items: center; cursor: pointer;
            position: absolute; top: -6px; left: 0;
        }
        .seek-bg { width: 100%; height: 2px; background: rgba(255,255,255,0.1); transition: height 0.2s; }
        .seek-fill { height: 100%; background: var(--accent-color); width: 0%; position: relative; }
        .seek-fill::after {
            content: ''; position: absolute; right: -6px; top: -5px; width: 12px; height: 12px;
            background: #fff; border-radius: 50%; transform: scale(0); transition: transform 0.2s;
        }
        .seek-container:hover .seek-bg { height: 4px; }
        .seek-container:hover .seek-fill::after { transform: scale(1); }

        .controls-row { display: flex; align-items: center; justify-content: space-between; }
        
        .btn-icon {
            width: 40px; height: 40px; border-radius: 50%; border: none;
            background: transparent; color: #ccc; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            transition: all 0.2s;
        }
        .btn-icon:hover { background: rgba(255,255,255,0.1); color: #fff; }
        .btn-main {
            width: 50px; height: 50px; background: #fff; color: #000;
            margin: 0 15px; box-shadow: 0 0 20px rgba(255,255,255,0.2);
        }
        .btn-main:hover { transform: scale(1.05); background: var(--accent-color); }
        
        .time-display { font-family: monospace; font-size: 0.85rem; color: #888; width: 120px; text-align: center; }

        /* --- FLOATING INSTRUCTIONS --- */
        .shortcut-panel {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0.9);
            width: 600px; background: rgba(20, 20, 20, 0.95);
            border: 1px solid rgba(255,255,255,0.1); border-radius: 20px;
            padding: 30px; z-index: 1000;
            opacity: 0; pointer-events: none; transition: 0.3s cubic-bezier(0.18, 0.89, 0.32, 1.28);
            box-shadow: 0 20px 50px rgba(0,0,0,0.8);
            backdrop-filter: blur(20px);
        }
        .shortcut-panel.open { opacity: 1; pointer-events: auto; transform: translate(-50%, -50%) scale(1); }
        .sc-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px; }
        .sc-item { display: flex; justify-content: space-between; border-bottom: 1px solid #333; padding: 8px 0; }
        .k-badge { 
            background: #333; padding: 2px 8px; border-radius: 4px; 
            font-family: monospace; border: 1px solid #444; font-size: 0.8rem; color: var(--accent-color);
        }

        /* --- UTILS --- */
        .hidden { display: none !important; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Mobile */
        @media(max-width: 900px) {
            #app { grid-template-columns: 1fr; grid-template-rows: 1fr 100px; }
            .sidebar, .right-panel { display: none; position: fixed; inset: 0; z-index: 200; background: #111; }
            .sidebar.mobile-open, .right-panel.mobile-open { display: flex; width: 85%; max-width: 320px; box-shadow: 10px 0 50px #000; }
        }
    </style>
</head>
<body>

<div id="app">
    <!-- SIDEBAR -->
    <aside class="sidebar" id="sidebar">
        <div class="app-logo">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="var(--accent-color)"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 14.5v-9l6 4.5-6 4.5z"/></svg>
            UltraPlay OS
        </div>
        
        <div class="search-container">
            <input type="text" class="search-input" id="search-bar" placeholder="Filter library...">
        </div>

        <div class="nav-btn active" onclick="ui.switchView('library')">
            <svg class="nav-icon" viewBox="0 0 24 24"><path d="M20 6h-8l-2-2H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2zm0 12H4V8h16v10z"/></svg>
            Library
        </div>
        <div class="nav-btn" onclick="ui.switchView('player')">
            <svg class="nav-icon" viewBox="0 0 24 24"><path d="M12 3v9.28c-.47-.17-.97-.28-1.5-.28C8.01 12 6 14.01 6 16.5S8.01 21 10.5 21c2.31 0 4.2-1.75 4.45-4H15V6h4V3h-7z"/></svg>
            Now Playing
        </div>
        <div class="nav-btn" onclick="document.getElementById('file-input').click()">
            <svg class="nav-icon" viewBox="0 0 24 24"><path d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zm2 16H8v-2h8v2zm0-4H8v-2h8v2zm-3-5V3.5L18.5 9H13z"/></svg>
            Import Media
        </div>
        
        <div class="sidebar-divider"></div>

        <div class="nav-btn" onclick="ui.toggleShortcuts()">
            <svg class="nav-icon" viewBox="0 0 24 24"><path d="M20 5H4c-1.1 0-1.99.9-1.99 2L2 17c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm-9 3h2v2h-2V8zm0 3h2v2h-2v-2zM8 8h2v2H8V8zm0 3h2v2H8v-2zm-1 2H5v-2h2v2zm0-3H5V8h2v2zm9 7H8v-2h8v2zm0-4h-2v-2h2v2zm0-3h-2V8h2v2zm3 3h-2v-2h2v2zm0-3h-2V8h2v2z"/></svg>
            Shortcuts
        </div>

        <div style="margin-top:auto"></div>
        <div class="nav-btn" style="color: #ff5555;" onclick="db.wipe()">
            <svg class="nav-icon" viewBox="0 0 24 24"><path d="M16 9v10H8V9h8m-1.5-6h-5l-1 1H5v2h14V4h-3.5l-1-1zM18 7H6v12c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7z"/></svg>
            Reset
        </div>
    </aside>

    <!-- STAGE -->
    <main class="stage">
        <video id="video-element" playsinline crossorigin="anonymous"></video>
        <canvas id="visualizer-canvas"></canvas>

        <!-- Library Overlay -->
        <div id="library-view" class="view-overlay active">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:30px;">
                <h2 style="margin:0; font-size:2rem; font-weight:800;">Media Library</h2>
                <button onclick="document.getElementById('file-input').click()" style="background:var(--accent-color); border:none; padding:10px 20px; border-radius:20px; font-weight:bold; cursor:pointer;">+ Add Files</button>
            </div>
            
            <div id="drop-zone" style="border: 2px dashed rgba(255,255,255,0.1); padding: 40px; text-align: center; border-radius: 20px; margin-bottom: 30px; color: #666; transition:0.3s;">
                <svg width="40" height="40" fill="#444" viewBox="0 0 24 24" style="display:block; margin:0 auto 10px;"><path d="M19.35 10.04C18.67 6.59 15.64 4 12 4 9.11 4 6.6 5.64 5.35 8.04 2.34 8.36 0 10.91 0 14c0 3.31 2.69 6 6 6h13c2.76 0 5-2.24 5-5 0-2.64-2.05-4.78-4.65-4.96zM14 13v4h-4v-4H7l5-5 5 5h-3z"/></svg>
                Drag & Drop Video or Audio files here
            </div>
            
            <div class="media-grid" id="media-grid"></div>
        </div>

        <!-- Shortcuts Panel -->
        <div id="shortcuts-panel" class="shortcut-panel">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h3 style="margin:0; color:#fff;">Keyboard Shortcuts</h3>
                <span onclick="ui.toggleShortcuts()" style="cursor:pointer; font-size:1.5rem;">&times;</span>
            </div>
            <div class="sc-grid">
                <div class="sc-item"><span>Play / Pause</span> <span class="k-badge">Space</span></div>
                <div class="sc-item"><span>Fullscreen</span> <span class="k-badge">F</span></div>
                <div class="sc-item"><span>Mute Toggle</span> <span class="k-badge">M</span></div>
                <div class="sc-item"><span>Picture in Picture</span> <span class="k-badge">P</span></div>
                
                <div class="sc-item"><span>Volume Up</span> <span class="k-badge">‚Üë</span> <span class="k-badge">Num 8</span></div>
                <div class="sc-item"><span>Volume Down</span> <span class="k-badge">‚Üì</span> <span class="k-badge">Num 2</span></div>
                <div class="sc-item"><span>Seek Forward</span> <span class="k-badge">‚Üí</span> <span class="k-badge">Num 6</span></div>
                <div class="sc-item"><span>Seek Backward</span> <span class="k-badge">‚Üê</span> <span class="k-badge">Num 4</span></div>
            </div>
            <p style="text-align:center; color:#666; font-size:0.8rem; margin-top:20px;">Press <span class="k-badge">?</span> to toggle this panel</p>
        </div>

        <!-- Toast -->
        <div id="toast" style="position: absolute; bottom: 120px; left: 50%; transform: translateX(-50%); background: rgba(20,20,20,0.9); padding: 12px 24px; border-radius: 30px; opacity: 0; transition: opacity 0.3s; pointer-events: none; border: 1px solid #333; z-index: 200; font-weight:500;">Action Completed</div>
    </main>

    <!-- RIGHT PANEL -->
    <aside class="right-panel">
        <div class="panel-tabs">
            <div class="panel-tab active" onclick="ui.switchTab('queue')">Queue</div>
            <div class="panel-tab" onclick="ui.switchTab('audio')">Mixer</div>
            <div class="panel-tab" onclick="ui.switchTab('video')">Display</div>
        </div>

        <div id="tab-queue" class="panel-content" style="flex:1; overflow-y:auto;">
            <div class="queue-list" id="queue-list"></div>
        </div>

        <div id="tab-audio" class="panel-content hidden" style="flex:1; overflow-y:auto;">
            <div class="control-group">
                <div class="control-header">MASTER</div>
                <div class="slider-row">
                    <span class="slider-label">Volume</span>
                    <input type="range" min="0" max="1" step="0.05" value="1" oninput="player.setVolume(this.value)">
                </div>
                <div class="slider-row">
                    <span class="slider-label">Speed</span>
                    <input type="range" min="0.5" max="2.5" step="0.25" value="1" oninput="player.setSpeed(this.value)">
                </div>
            </div>
            <div class="control-group">
                <div class="control-header">EQUALIZER (3-BAND)</div>
                <div class="slider-row"><span class="slider-label">Bass</span> <input type="range" min="-12" max="12" value="0" oninput="audioEngine.setEq('bass', this.value)"></div>
                <div class="slider-row"><span class="slider-label">Mid</span> <input type="range" min="-12" max="12" value="0" oninput="audioEngine.setEq('mid', this.value)"></div>
                <div class="slider-row"><span class="slider-label">Treble</span> <input type="range" min="-12" max="12" value="0" oninput="audioEngine.setEq('treble', this.value)"></div>
            </div>
            <div class="control-group">
                <div class="control-header">SLEEP TIMER</div>
                <select onchange="player.setSleepTimer(this.value)" style="width:100%; background:#222; border:1px solid #444; color:#fff; padding:8px; border-radius:6px;">
                    <option value="0">Off</option>
                    <option value="15">15 Minutes</option>
                    <option value="30">30 Minutes</option>
                    <option value="60">1 Hour</option>
                </select>
            </div>
        </div>

        <div id="tab-video" class="panel-content hidden">
            <div class="control-group">
                <div class="control-header">IMAGE ADJUSTMENT</div>
                <div class="slider-row"><span class="slider-label">Bright</span> <input type="range" min="0.5" max="1.5" step="0.1" value="1" oninput="player.setFilter('brightness', this.value)"></div>
                <div class="slider-row"><span class="slider-label">Contrast</span> <input type="range" min="0.5" max="1.5" step="0.1" value="1" oninput="player.setFilter('contrast', this.value)"></div>
                <div class="slider-row"><span class="slider-label">Sat</span> <input type="range" min="0" max="2" step="0.1" value="1" oninput="player.setFilter('saturate', this.value)"></div>
                <div class="slider-row"><span class="slider-label">Hue</span> <input type="range" min="0" max="360" step="10" value="0" oninput="player.setFilter('hue-rotate', this.value+'deg')"></div>
            </div>
            <div class="control-group">
                <button class="nav-btn" onclick="document.getElementById('sub-input').click()" style="width:100%; justify-content:center; background:#222;">Load Subtitle (.srt)</button>
            </div>
        </div>
    </aside>

    <!-- PLAYER BAR -->
    <div class="player-bar">
        <div class="seek-container" id="seek-container">
            <div class="seek-bg"><div class="seek-fill" id="seek-fill"></div></div>
        </div>
        
        <div class="controls-row">
            <!-- Left: Meta -->
            <div style="width:200px; display:flex; flex-direction:column; justify-content:center;">
                <div id="np-title" style="font-size:0.9rem; font-weight:600; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">No Media</div>
                <div id="time-display" class="time-display" style="text-align:left; font-size:0.75rem;">--:-- / --:--</div>
            </div>

            <!-- Center: Controls -->
            <div style="display: flex; align-items: center;">
                <button class="btn-icon" onclick="player.prev()"><svg width="24" height="24" fill="currentColor" viewBox="0 0 24 24"><path d="M6 6h2v12H6zm3.5 6l8.5 6V6z"/></svg></button>
                <button class="btn-icon btn-main" id="play-btn" onclick="player.togglePlay()"><svg width="32" height="32" fill="currentColor" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg></button>
                <button class="btn-icon" onclick="player.next()"><svg width="24" height="24" fill="currentColor" viewBox="0 0 24 24"><path d="M6 18l8.5-6L6 6v12zM16 6v12h2V6h-2z"/></svg></button>
            </div>

            <!-- Right: Tools -->
            <div style="width:200px; display: flex; justify-content: flex-end; gap: 10px;">
                <button class="btn-icon" title="Mute (M)" onclick="player.toggleMute()"><svg id="vol-icon" width="22" height="22" fill="currentColor" viewBox="0 0 24 24"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02z"/></svg></button>
                <button class="btn-icon" title="PiP (P)" onclick="player.togglePip()"><svg width="20" height="20" fill="currentColor" viewBox="0 0 24 24"><path d="M19 11h-8v6h8v-6zm4 8V4.98C23 3.88 22.1 3 21 3H3c-1.1 0-2 .88-2 1.98V19c0 1.1.9 2 2 2h18c1.1 0 2-.9 2-2zm-2 .02H3V4.97h18v14.05z"/></svg></button>
                <button class="btn-icon" title="Fullscreen (F)" onclick="player.toggleFullscreen()"><svg width="24" height="24" fill="currentColor" viewBox="0 0 24 24"><path d="M7 14H5v5h5v-2H7v-3zm-2-4h2V7h3V5H5v5zm12 7h-3v2h5v-5h-2v3zM14 5v2h3v3h2V5h-5z"/></svg></button>
            </div>
        </div>
    </div>
</div>

<!-- Invisible Inputs -->
<input type="file" id="file-input" multiple accept="video/*,audio/*" class="hidden">
<input type="file" id="sub-input" accept=".srt,.vtt" class="hidden">

<script>
/**
 * ULTRA PLAY OS v2.1
 * Performance Optimized, Keymapped, Feature-Rich
 */

const Utils = {
    fmtTime: s => {
        if (!s || isNaN(s)) return "00:00";
        let h = Math.floor(s / 3600);
        let m = Math.floor((s % 3600) / 60);
        let sec = Math.floor(s % 60);
        return (h > 0 ? h + ':' : '') + (m < 10 ? '0'+m : m) + ':' + (sec < 10 ? '0'+sec : sec);
    },
    uuid: () => Math.random().toString(36).substr(2, 9),
    srtToVtt: (srt) => "WEBVTT\n\n" + srt.replace(/(\d{2}):(\d{2}):(\d{2}),(\d{3})/g, '$1:$2:$3.$4').replace(/\r\n/g, '\n'),
    debounce: (func, wait) => {
        let timeout;
        return function executedFunction(...args) {
            const later = () => { clearTimeout(timeout); func(...args); };
            clearTimeout(timeout); timeout = setTimeout(later, wait);
        };
    }
};

// --- DATABASE ---
class Store {
    constructor() { this.db = null; this.ready = this.init(); }
    init() {
        return new Promise(r => {
            const req = indexedDB.open('UltraPlayV2', 3);
            req.onupgradeneeded = e => {
                const db = e.target.result;
                if (!db.objectStoreNames.contains('library')) db.createObjectStore('library', { keyPath: 'id' });
            };
            req.onsuccess = e => { this.db = e.target.result; r(); };
        });
    }
    async add(file) {
        await this.ready;
        const meta = { id: Utils.uuid(), name: file.name, type: file.type, blob: file, size: file.size, added: Date.now(), thumb: null };
        this.db.transaction('library', 'readwrite').objectStore('library').add(meta);
        return meta;
    }
    async getAll() {
        await this.ready;
        return new Promise(r => this.db.transaction('library').objectStore('library').getAll().onsuccess = e => r(e.target.result));
    }
    async update(item) { this.db.transaction('library', 'readwrite').objectStore('library').put(item); }
    async wipe() { indexedDB.deleteDatabase('UltraPlayV2'); location.reload(); }
}

// --- WORKER FOR NON-BLOCKING THUMBS ---
class ThumbWorker {
    constructor() { this.queue = []; this.busy = false; }
    enqueue(item) {
        if(item.type.startsWith('audio')) return;
        this.queue.push(item);
        this.process();
    }
    async process() {
        if (this.busy || !this.queue.length) return;
        this.busy = true;
        const item = this.queue.shift();
        try {
            item.thumb = await this.gen(item.blob);
            await db.update(item);
            ui.updateThumb(item.id, item.thumb);
        } catch(e) {}
        this.busy = false;
        setTimeout(() => this.process(), 50);
    }
    gen(blob) {
        return new Promise(r => {
            const v = document.createElement('video');
            v.src = URL.createObjectURL(blob);
            v.muted = true; v.currentTime = 5;
            v.onseeked = () => {
                const c = document.createElement('canvas');
                c.width = 320; c.height = 180;
                c.getContext('2d').drawImage(v, 0, 0, c.width, c.height);
                r(c.toDataURL('image/jpeg', 0.5));
                v.src = '';
            };
            v.onerror = () => r(null);
        });
    }
}

// --- AUDIO ENGINE ---
class AudioEngine {
    constructor(video) {
        this.v = video;
        this.ctx = new (window.AudioContext || window.webkitAudioContext)();
        this.src = this.ctx.createMediaElementSource(this.v);
        
        this.bass = this.ctx.createBiquadFilter(); this.bass.type = 'lowshelf'; this.bass.frequency.value = 200;
        this.mid = this.ctx.createBiquadFilter(); this.mid.type = 'peaking'; this.mid.frequency.value = 1000;
        this.treble = this.ctx.createBiquadFilter(); this.treble.type = 'highshelf'; this.treble.frequency.value = 3000;
        
        this.analyser = this.ctx.createAnalyser();
        this.analyser.fftSize = 128; // Lower for performance

        this.src.connect(this.bass).connect(this.mid).connect(this.treble).connect(this.analyser).connect(this.ctx.destination);
        this.drawVisualizer();
    }
    setEq(b, v) { this[b].gain.value = v; }
    drawVisualizer() {
        const c = document.getElementById('visualizer-canvas');
        const ctx = c.getContext('2d');
        const data = new Uint8Array(this.analyser.frequencyBinCount);
        
        const loop = () => {
            requestAnimationFrame(loop);
            // Performance: Don't draw if video paused or visualizer hidden
            if (this.v.paused || c.style.display === 'none') return; 

            c.width = c.clientWidth; c.height = c.clientHeight; // Responsive
            this.analyser.getByteFrequencyData(data);
            ctx.clearRect(0, 0, c.width, c.height);
            
            const barW = (c.width / data.length) * 2.5;
            let x = 0;
            
            for(let i = 0; i < data.length; i++) {
                const barH = (data[i] / 255) * c.height;
                ctx.fillStyle = `rgba(0, 242, 255, ${data[i]/300})`; // Cyan w/ opacity
                ctx.fillRect(x, c.height - barH, barW, barH);
                x += barW + 2;
            }
        };
        loop();
    }
}

// --- PLAYER CONTROLLER ---
class Player {
    constructor() {
        this.v = document.getElementById('video-element');
        this.queue = [];
        this.idx = -1;
        this.filters = {};
        this.sleepTimer = null;
        
        this.v.ontimeupdate = () => this.tick();
        this.v.onended = () => this.next();
    }
    
    async load(item) {
        if(!audioEngine) { audioEngine = new AudioEngine(this.v); }
        if(audioEngine.ctx.state === 'suspended') audioEngine.ctx.resume();

        this.v.src = URL.createObjectURL(item.blob);
        document.getElementById('np-title').innerText = item.name;
        
        // Show/Hide Visualizer based on type
        const isAudio = item.type.startsWith('audio');
        document.getElementById('visualizer-canvas').style.display = isAudio ? 'block' : 'none';
        
        try { await this.v.play(); } catch(e) {}
        ui.highlightQueue(this.idx);
        ui.switchView('player');
    }

    playQueue(list, idx) { this.queue = list; this.idx = idx; ui.renderQueue(list); this.load(list[idx]); }
    
    togglePlay() { this.v.paused ? this.v.play() : this.v.pause(); this.updBtn(); }
    toggleMute() { this.v.muted = !this.v.muted; ui.toast(this.v.muted ? 'Muted' : 'Unmuted'); }
    
    next() { if(this.idx < this.queue.length-1) { this.idx++; this.load(this.queue[this.idx]); } }
    prev() { if(this.idx > 0) { this.idx--; this.load(this.queue[this.idx]); } }
    
    seek(pct) { if(this.v.duration) this.v.currentTime = this.v.duration * pct; }
    seekStep(sec) { this.v.currentTime = Math.max(0, Math.min(this.v.duration, this.v.currentTime + sec)); ui.toast(`${sec > 0 ? '+' : ''}${sec}s`); }
    
    setVolume(v) { this.v.volume = Math.max(0, Math.min(1, parseFloat(v))); ui.toast(`Volume: ${Math.round(this.v.volume*100)}%`); }
    setSpeed(s) { this.v.playbackRate = s; ui.toast(`Speed: ${s}x`); }
    setFilter(n, v) { this.filters[n] = v; this.applyFilters(); }
    applyFilters() { this.v.style.filter = Object.entries(this.filters).map(([k,v]) => `${k}(${v})`).join(' '); }
    
    setSleepTimer(min) {
        if(this.sleepTimer) clearTimeout(this.sleepTimer);
        if(min > 0) {
            ui.toast(`Sleep in ${min} min`);
            this.sleepTimer = setTimeout(() => { this.v.pause(); ui.toast("Sleep Timer: Paused"); }, min * 60000);
        }
    }

    tick() {
        const d = this.v.duration || 0, c = this.v.currentTime || 0;
        document.getElementById('seek-fill').style.width = ((c/d)*100)+'%';
        document.getElementById('time-display').innerText = `${Utils.fmtTime(c)} / ${Utils.fmtTime(d)}`;
        this.updBtn();
    }
    
    updBtn() {
        document.getElementById('play-btn').innerHTML = this.v.paused 
        ? '<svg width="32" height="32" fill="currentColor" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>' 
        : '<svg width="32" height="32" fill="currentColor" viewBox="0 0 24 24"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>';
    }

    toggleFullscreen() { !document.fullscreenElement ? document.body.requestFullscreen() : document.exitFullscreen(); }
    togglePip() { document.pictureInPictureElement ? document.exitPictureInPicture() : this.v.requestPictureInPicture(); }
}

// --- UI MANAGER ---
class UI {
    constructor() {
        this.setupDrag();
        this.setupSeek();
        this.setupKeys();
        
        // Search
        document.getElementById('search-bar').addEventListener('input', Utils.debounce(e => {
            this.renderLibrary(e.target.value);
        }, 300));
    }

    switchView(v) {
        document.querySelectorAll('.view-overlay').forEach(e => e.classList.remove('active'));
        document.querySelectorAll('.nav-btn').forEach(e => e.classList.remove('active'));
        if(v === 'library') {
            document.getElementById('library-view').classList.add('active');
            document.querySelectorAll('.nav-btn')[0].classList.add('active');
        } else {
            document.querySelectorAll('.nav-btn')[1].classList.add('active');
        }
    }

    switchTab(t) {
        document.querySelectorAll('.panel-content').forEach(e => e.classList.add('hidden'));
        document.querySelectorAll('.panel-tab').forEach(e => e.classList.remove('active'));
        document.getElementById(`tab-${t}`).classList.remove('hidden');
        event.target.classList.add('active');
    }

    async renderLibrary(filter = '') {
        const items = await db.getAll();
        const grid = document.getElementById('media-grid');
        grid.innerHTML = '';
        
        const filtered = items.filter(i => i.name.toLowerCase().includes(filter.toLowerCase()));
        
        filtered.forEach(item => {
            const el = document.createElement('div');
            el.className = 'media-card'; el.id = `c-${item.id}`;
            el.innerHTML = `
                <div class="thumb-box" style="background-image: url('${item.thumb || ''}')">
                    ${!item.thumb ? (item.type.startsWith('audio') ? 'üéµ' : 'üé¨') : ''}
                    <div class="play-overlay"><svg width="40" height="40" fill="#fff" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg></div>
                </div>
                <div class="info-box">
                    <div class="file-name">${item.name}</div>
                    <div class="file-meta"><span>${(item.size/1024/1024).toFixed(1)}MB</span> <span>${new Date(item.added).toLocaleDateString()}</span></div>
                </div>`;
            el.onclick = () => player.playQueue(filtered, filtered.indexOf(item));
            grid.appendChild(el);
            if(!item.thumb && item.type.startsWith('video')) thumbWorker.enqueue(item);
        });
    }

    updateThumb(id, url) {
        const el = document.getElementById(`c-${id}`);
        if(el) {
            const box = el.querySelector('.thumb-box');
            box.style.backgroundImage = `url('${url}')`;
            box.innerText = '';
            box.innerHTML = `<div class="play-overlay"><svg width="40" height="40" fill="#fff" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg></div>`;
        }
    }

    renderQueue(list) {
        const c = document.getElementById('queue-list'); c.innerHTML = '';
        list.forEach((item, i) => {
            const d = document.createElement('div');
            d.className = 'queue-item'; d.id = `q-${i}`;
            d.innerHTML = `${i === player.idx ? '<div class="playing-indicator"></div>' : ''} <div style="flex:1; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; font-size:0.85rem;">${item.name}</div>`;
            d.onclick = () => { player.idx = i; player.load(item); };
            c.appendChild(d);
        });
    }

    highlightQueue(idx) {
        document.querySelectorAll('.queue-item').forEach(e => { e.classList.remove('playing'); if(e.querySelector('.playing-indicator')) e.querySelector('.playing-indicator').remove(); });
        const el = document.getElementById(`q-${idx}`);
        if(el) {
            el.classList.add('playing');
            el.insertAdjacentHTML('afterbegin', '<div class="playing-indicator"></div>');
            el.scrollIntoView({block:'center', behavior:'smooth'});
        }
    }

    toast(m) {
        const t = document.getElementById('toast');
        t.innerText = m; t.style.opacity = 1; t.style.bottom = '120px';
        setTimeout(() => { t.style.opacity = 0; t.style.bottom = '100px'; }, 2000);
    }
    
    toggleShortcuts() { document.getElementById('shortcuts-panel').classList.toggle('open'); }

    setupDrag() {
        const z = document.getElementById('drop-zone');
        z.ondragover = e => { e.preventDefault(); z.style.borderColor = 'var(--accent-color)'; z.style.background = 'rgba(255,255,255,0.05)'; };
        z.ondragleave = () => { z.style.borderColor = 'rgba(255,255,255,0.1)'; z.style.background = 'transparent'; };
        z.ondrop = async e => {
            e.preventDefault(); z.ondragleave();
            const files = Array.from(e.dataTransfer.files).filter(f => f.type.match(/video|audio/));
            if(files.length) {
                this.toast(`Processing ${files.length} files...`);
                for(const f of files) await db.add(f);
                this.renderLibrary();
            }
        };
        document.getElementById('file-input').onchange = async e => {
            for(const f of e.target.files) await db.add(f);
            this.renderLibrary();
        };
        // Subtitles
        document.getElementById('sub-input').onchange = e => {
            const f = e.target.files[0];
            const r = new FileReader();
            r.onload = v => {
                const b = new Blob([f.name.endsWith('.srt') ? Utils.srtToVtt(v.target.result) : v.target.result], {type:'text/vtt'});
                const t = document.createElement('track'); t.kind='subtitles'; t.label='English'; t.srclang='en'; t.src=URL.createObjectURL(b); t.default=true;
                player.v.appendChild(t); ui.toast('Subtitles Loaded');
            };
            r.readAsText(f);
        };
    }

    setupSeek() {
        const c = document.getElementById('seek-container');
        c.onclick = e => player.seek((e.clientX - c.getBoundingClientRect().left) / c.offsetWidth);
    }

    setupKeys() {
        window.addEventListener('keydown', e => {
            if(e.target.tagName === 'INPUT') return;
            const p = player;
            switch(e.code) {
                case 'Space': e.preventDefault(); p.togglePlay(); break;
                case 'KeyF': p.toggleFullscreen(); break;
                case 'KeyM': p.toggleMute(); break;
                case 'KeyP': p.togglePip(); break;
                case 'ArrowRight': case 'Numpad6': p.seekStep(5); break;
                case 'ArrowLeft': case 'Numpad4': p.seekStep(-5); break;
                case 'ArrowUp': case 'Numpad8': e.preventDefault(); p.setVolume(p.v.volume + 0.1); break;
                case 'ArrowDown': case 'Numpad2': e.preventDefault(); p.setVolume(p.v.volume - 0.1); break;
                case 'Slash': if(e.shiftKey) ui.toggleShortcuts(); break; // ? key
            }
        });
    }
}

// --- INIT ---
const db = new Store();
const thumbWorker = new ThumbWorker();
const ui = new UI();
const player = new Player();
let audioEngine;

(async () => {
    await db.ready;
    ui.renderLibrary();
})();

</script>
</body>
</html>